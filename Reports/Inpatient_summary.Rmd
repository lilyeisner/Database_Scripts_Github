---
title: "MOOD BRAIN & DEVELOPMENT UNIT"
output:
  word_document:
    fig_caption: yes
    fig_height: 5
    fig_width: 7
    reference_docx: template.docx
  html_document:
    df_print: paged
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# !diagnostics off
```

```{r echo=FALSE, warning=FALSE, message=FALSE, results="hide" }

##### need the following if running script from this window

# directories -------------------------------------------------------------

computer = 'pc' # set this to either 'mac' or 'pc' (Georgia = W:/ as I have string mounted differently)

if (computer=="pc") {
  string = 'W:/'
  sdan1 = 'Y:/'
} else if (computer=="mac") {
  string = '/Volumes/string-mbd/'
  sdan1 = '/Volumes/sdan1/'
}

database_location = paste0(string, "Database/Master Psychometric Database/") # tasks database also located here
IRTA_tracker_location = paste0(string, "Database/Master Participant Tracker/")
scripts = paste0(string, "Database/Database_Scripts_Github/") # temp useful directory while scripts are still under development
inpatient_location = paste0(database_location, "Inpatient/") 
inpatient_backup = paste0(inpatient_location, "Backup/") 
inpatient_summary_location = paste0(inpatient_location, "Reports/")

# packages ----------------------------------------------------------------

suppressPackageStartupMessages(library(readxl))
suppressPackageStartupMessages(library(writexl))
suppressPackageStartupMessages(library(tidyr))
suppressPackageStartupMessages(library(dplyr))
suppressPackageStartupMessages(library(rmarkdown))
suppressPackageStartupMessages(library(eeptools))
suppressPackageStartupMessages(library(openxlsx))
suppressPackageStartupMessages(library(data.table))
suppressPackageStartupMessages(library(reshape2))
suppressPackageStartupMessages(library(stringr))
suppressPackageStartupMessages(library(lubridate))
suppressPackageStartupMessages(library(ggplot2))
suppressPackageStartupMessages(library(rlang))
suppressPackageStartupMessages(library(purrr))
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(shiny))
suppressPackageStartupMessages(library(knitr))
suppressPackageStartupMessages(library(flextable))

# functions ---------------------------------------------------------------

count_na <- function(x) sum(is.na(x))

FitFlextableToPage <- function(ft, pgwidth = 10){
  ft_out <- ft %>% autofit(., add_h = 0.3)
  ft_out <- width(ft_out, width = dim(ft_out)$widths*10.5/(flextable_dim(ft_out)$widths))
  return(ft_out)
}

# other to load if running script here ------------------------------------

to_change <- read_excel(paste0(scripts, "to_change_before_running_master_script.xlsx"))
todays_date_formatted <- c(to_change$todays_date_formatted)
todays_date_formatted <- as.Date(todays_date_formatted)
# todays_date_formatted <- as.Date("2019-12-16")

```

```{r echo=FALSE, warning=FALSE, message=FALSE, results="hide" }

# Loading data ------------------------------------------------------------

todays_date <- todays_date_formatted %>% format(., "%B %d %Y")

if (exists("MATCH_tracker")==FALSE) {
        inpatient_database_file <- list.files(path = paste0(inpatient_location), pattern = "^MASTER_DATABASE_Inpatient", all.files = FALSE,
                                 full.names = FALSE, recursive = FALSE, ignore.case = FALSE, include.dirs = FALSE, no.. = FALSE)
        inpatient_database_file_time <- file.mtime(paste0(inpatient_location, inpatient_database_file)) %>% as.Date()
        inpatient_database_combined <- tibble(File=c(inpatient_database_file), Date=c(inpatient_database_file_time)) %>% arrange(desc(Date)) %>% slice(1)
        MATCH_tracker <- read_excel(paste0(inpatient_location, inpatient_database_combined[1]))
        rm(inpatient_database_file, inpatient_database_file_time, inpatient_database_combined)
} 

# Data needed for inpatient summaries -------------------------------------

current_inpatients <- MATCH_tracker %>% group_by(Initials) %>% arrange(Clinical_Visit_Date) %>% slice(n()) %>% ungroup() %>% filter(Eligible=="Include" | is.na(Eligible)) %>% 
    select(FIRST_NAME, LAST_NAME, Initials, SDAN, Age_at_visit, SEX, c_ksadsdx_dx_detailed, IRTA_tracker)

inpatient_list <- c(current_inpatients$Initials)

data <- MATCH_tracker %>% filter(Initials %in% inpatient_list) %>% 
  select(Initials, Clinical_Visit_Date, Clinical_Visit_Type, s_mfq1w_tot, s_ari1w_tot, s_scared_tot, s_shaps_tot, s_lsas_tot, s_vadis_tot, s_rumination_tot, s_chocir_symptom_tot,
         s_chocir_impairment_tot, s_seq_tot, p_conners_tot, c_snap_tot, c_cybocs_ob_tot, c_cybocs_com_tot, matches("c_medsclin_"))

############# insert code to collate meds/create separate dataframe for just the meds??? 

```

##### Inpatient summary, `r todays_date` 

***

```{r echo=FALSE, warning=FALSE, message=FALSE, results="asis"}

for(i in seq(nrow(current_inpatients))) {
  # iter=3
  iter <- as.numeric(i)
  
  Participant <- inpatient_list[iter]
    
  temp <- data %>% filter(Initials==Participant)

  cat("  \n",  "  \n###",  iter, "-", temp[1,1], "", temp[1,2], "(", temp[1,3], ")")
  
  demo_table <- flextable(temp, col_keys = c(
    
    # "Participant_Type", "IRTA_tracker", "DOB", "Age_at_visit", "SEX", "City", "State", "Marital_Status", 
    # "Eligible", "DAWBA_ID", "Referral_Source", "MFQ_tot", "Clinical_Visit_Date", "NIMH_Clinician"
    
    )) %>%
    set_header_labels(., 
                      
                    #   Participant_Type="Type", IRTA_tracker="IRTA", DOB="DOB", Age_at_visit="Age", SEX="Sex", City="City", State="State", Marital_Status="Marital Status",
                    # Eligible="Eligible", DAWBA_ID="DAWBA_ID", Referral_Source="Referral Source", MFQ_tot="MFQ tot", Clinical_Visit_Date="Clinical Visit Date", 
                    # NIMH_Clinician="Clinician"
                    
                    
                    ) %>%
    fontsize(., size=8, part="all") %>% align(., align = "left", part="all") %>% FitFlextableToPage(.)

  cat(knit_print(demo_table))
  
  questionnaire_data <- flextable(temp, col_keys = c(
    
    # "Diagnoses_of_note", "Medications", "Metal_screen", "Notes"
    
    )) %>%
    set_header_labels(., 
                      
                      # Diagnoses_of_note="Diagnoses of note", Medications="Medications", Metal_screen="Metal screen", Notes="Notes"
                      
                      ) %>%
    fontsize(., size=8, part="all") %>% align(., align = "left", part="all") %>% FitFlextableToPage(.)
  
  cat(knit_print(questionnaire_data))
  
}
  
```

```{r echo=FALSE, warning=FALSE, message=FALSE, results="hide" }

# removing finished variables

rm(temp, iter, i, demo_table, questionnaire_data)

```
