---
title: "Continuing_review"
author: "Georgia O'Calllaghan"
output: html_document
---

```{r echo=FALSE, warning=FALSE, message=FALSE, results="hide" }

rm(list = ls()) # command to clear all variables from R environment

computer = 'mac' # set this to either 'mac' or 'pc' or 'other'
if (computer=="pc") {
  string = 'W:/'
  sdan1 = 'Y:/'
} else if (computer=="mac") {
  string = '/Volumes/string-mbd/'
  sdan1 = '/Volumes/SDAN1/'
} else { # if using a PC and your drives aren't mounted as specified above, enter what letter your drives are mounted under here... 
  string = 'W:/'
  sdan1 = 'Y:/'
}

# main folders needed
database_location = paste0(string, "Database/Master Psychometric Database/") # tasks database also located here 
IRTA_tracker_location = paste0(string, "Database/Master Participant Tracker/")
setwd(database_location)

# Set output file for script results
# output_location <- '~/Desktop/ContinuingReviewOutput.txt' # change to be where you want output to go

last_CR <- as.Date("2019-08-01")

# loading packages --------------------------------------------------------

library(dplyr)
library(ggplot2)
library(readxl)
library(openxlsx)
library(tidyr)
library(stringr)
library(kableExtra)
library(summarytools)

# loading data ------------------------------------------------------------

if (exists("master_IRTA_latest")==FALSE) {
  irta_master_file <- list.files(path = paste0(IRTA_tracker_location), pattern = "^MASTER_IRTA_DATABASE", all.files = FALSE,
    full.names = FALSE, recursive = FALSE, ignore.case = FALSE, include.dirs = FALSE, no.. = FALSE)
  irta_master_file_time <- file.mtime(paste0(IRTA_tracker_location, "/", irta_master_file)) %>% as.Date()
  irta_master_combined <- tibble(File=c(irta_master_file), Date=c(irta_master_file_time)) %>% arrange(desc(Date)) %>% slice(1)
  master_IRTA_latest <- read_excel(paste0(IRTA_tracker_location, irta_master_combined[1]))
  date_variabes <- c("DOB", "Screening_Start_Date", "Referral_Date", "Consent_Date", "Clinical_Visit_Date", "Clinicals_date", "Overall_date")
  master_IRTA_latest[date_variabes] <- lapply(master_IRTA_latest[date_variabes], as.Date)
  rm(i, date_variabes, irta_master_file, irta_master_file_time, irta_master_combined)
} else {
  print("master IRTA tracker already imported")
}

if (exists("master_IRTA_oldest_screens_latest")==FALSE) {
  irta_old_screens_file <- list.files(path = paste0(IRTA_tracker_location), pattern = "^OLD_REFERRALS_DATABASE", all.files = FALSE,
    full.names = FALSE, recursive = FALSE, ignore.case = FALSE, include.dirs = FALSE, no.. = FALSE)
  irta_old_screens_file_time <- file.mtime(paste0(IRTA_tracker_location, "/", irta_old_screens_file)) %>% as.Date()
  irta_old_screens_combined <- tibble(File=c(irta_old_screens_file), Date=c(irta_old_screens_file_time)) %>% arrange(desc(Date)) %>% slice(1)
  master_IRTA_oldest_screens_latest <- read_excel(paste0(IRTA_tracker_location, irta_old_screens_combined[1]))
  date_variabes <- c("DOB", "Screening_Start_Date", "Referral_Date", "Consent_Date", "Clinical_Visit_Date", "Clinicals_date", "Overall_date")
  master_IRTA_oldest_screens_latest[date_variabes] <- lapply(master_IRTA_oldest_screens_latest[date_variabes], as.Date) 
  rm(date_variabes, irta_old_screens_file, irta_old_screens_file_time, irta_old_screens_combined)
} else {
  print("IRTA tracker screens (OLD) already imported")
}

if (exists("master_IRTA_screens_latest")==FALSE) {
  irta_ongoing_screens_file <- list.files(path = paste0(IRTA_tracker_location), pattern = "^REFERRAL_AND_SCREENING_DATABASE", all.files = FALSE,
    full.names = FALSE, recursive = FALSE, ignore.case = FALSE, include.dirs = FALSE, no.. = FALSE)
  irta_ongoing_screens_file_time <- file.mtime(paste0(IRTA_tracker_location, "/", irta_ongoing_screens_file)) %>% as.Date()
  irta_ongoing_screens_combined <- tibble(File=c(irta_ongoing_screens_file), Date=c(irta_ongoing_screens_file_time)) %>% 
    arrange(desc(Date)) %>% slice(1)
  master_IRTA_screens_latest <- read_excel(paste0(IRTA_tracker_location, irta_ongoing_screens_combined[1]))
  date_variabes <- c("DOB", "Screening_Start_Date", "Referral_Date", "Consent_Date", "Clinical_Visit_Date", "Clinicals_date", "Overall_date")
  master_IRTA_screens_latest[date_variabes] <- lapply(master_IRTA_screens_latest[date_variabes], as.Date) 
  rm(date_variabes, irta_ongoing_screens_file, irta_ongoing_screens_file_time, irta_ongoing_screens_combined)
} else {
  print("IRTA tracker screens (ONGOING) already imported")
}

if (exists("Psychometrics_treatment")==FALSE) {
  master_database_file <- list.files(path = paste0(database_location), pattern = "^MASTER_DATABASE_CLINICAL", all.files = FALSE,
    full.names = FALSE, recursive = FALSE, ignore.case = FALSE, include.dirs = FALSE, no.. = FALSE)
  master_database_file_time <- file.mtime(paste0(database_location, "/", master_database_file)) %>% as.Date()
  master_database_combined <- tibble(File=c(master_database_file), Date=c(master_database_file_time)) %>% 
    arrange(desc(Date)) %>% slice(1)
  Psychometrics_treatment <- read_excel(paste0(database_location, master_database_combined[1]))
  demo <- Psychometrics_treatment %>% select(Initials, SDAN, PLUSID, IRTA_tracker, p_demo_screen_background_race, p_demo_screen_background_hispanic) %>% 
    distinct(., .keep_all = TRUE) %>% filter(!is.na(p_demo_screen_background_race) | !is.na(p_demo_screen_background_hispanic))
  rm(master_database_file, master_database_file_time, master_database_combined)
} else {
  print("clinical database info already imported")
  demo <- Psychometrics_treatment %>% select(Initials, SDAN, PLUSID, IRTA_tracker, p_demo_screen_background_race, p_demo_screen_background_hispanic) %>% 
    distinct(., .keep_all = TRUE) %>% filter(!is.na(p_demo_screen_background_race) | !is.na(p_demo_screen_background_hispanic))
}

# Combining screening data  --------------------------------------------

econsent_0037_latest <- master_IRTA_screens_latest %>% select(Initials, FIRST_NAME, LAST_NAME, PLUSID, IRTA_tracker, Participant_Type2, SEX, 
    Eligible, Eligibility_notes, Referral_Date, Screening_Start_Date, Parent_e_consented, Parent2_e_consented, Child_e_assented, 
    DAWBA_completed, Parent_DAWBA_completed, Child_DAWBA_completed) %>% mutate(screen_type = "ongoing")

econsent_0037_old <- master_IRTA_oldest_screens_latest %>% select(Initials, FIRST_NAME, LAST_NAME, PLUSID, IRTA_tracker, Participant_Type2, SEX, 
  Eligible, Eligibility_notes, Referral_Date, Screening_Start_Date, Parent_e_consented, Parent2_e_consented, Child_e_assented, 
  DAWBA_completed, Parent_DAWBA_completed, Child_DAWBA_completed) %>% mutate(screen_type = "old")

econsent_0037_combined <- merge.default(econsent_0037_latest, econsent_0037_old, all = TRUE)
econsent_0037_combined$Overall_date <- coalesce(econsent_0037_combined$Referral_Date, econsent_0037_combined$Screening_Start_Date) %>% as.Date()
econsent_0037_combined <- econsent_0037_combined %>% filter(!is.na(Overall_date))

```

Today's date: `r Sys.Date()`

*** 

##### In the past year:

Period since, `r last_CR`

```{r echo=FALSE, warning=FALSE, message=FALSE, results="hide" }

######################## had eval
# first time they signed into 0037

protocol_0037_first <- master_IRTA_latest %>% filter(str_detect(Protocol, "0037")) %>% group_by(Initials) %>% 
  slice(1) %>% ungroup() %>% select(Initials, SDAN, PLUSID, IRTA_tracker, Participant_Type2, SEX, 
    Eligible, Eligibility_notes, 
    Clinical_Visit_Type, Clinical_Visit_Date, 
    Consent_Date, Protocol, 
    Referral_Date, Screening_Start_Date, 
    Parent_e_consented, Parent2_e_consented, Child_e_assented, 
    DAWBA_completed, Parent_DAWBA_completed, Child_DAWBA_completed) %>% 
  filter(Participant_Type2=="MDD" | Participant_Type2=="HV") %>% mutate(Protocol_Type = NA)

protocol_0037_first$Protocol_Type[str_detect(protocol_0037_first$Protocol, 'SCREENING')] <- 'Screening'
protocol_0037_first$Protocol_Type[str_detect(protocol_0037_first$Protocol, 'Screening')] <- 'Screening'
protocol_0037_first$Protocol_Type[is.na(protocol_0037_first$Protocol_Type)] <- 'Characterization'
fill_in <- c("Parent_e_consented", "Parent2_e_consented", "Child_e_assented", "DAWBA_completed", "Parent_DAWBA_completed", "Child_DAWBA_completed")
protocol_0037_first[fill_in] <- lapply(protocol_0037_first[fill_in], replace_na, "1")

protocol_0037_first$Overall_date <- coalesce(protocol_0037_first$Clinical_Visit_Date, protocol_0037_first$Screening_Start_Date) %>% 
  coalesce(., protocol_0037_first$Referral_Date) %>% as.Date()
protocol_0037_first <- left_join(protocol_0037_first, demo)
protocol_0037_past_year <- protocol_0037_first %>% filter(Overall_date >= last_CR)

######################## screening only

econsent_0037_past_year <- econsent_0037_combined %>% filter(Overall_date >= last_CR)

# The data we need  --------------------------------------------

######## Participants in the past year (evals)

protocol_table <- ctable(protocol_0037_past_year$Participant_Type2, protocol_0037_past_year$Protocol_Type, 
                  useNA = "always", prop="r", totals=FALSE, display.type=FALSE) %>% 
  as.data.frame() %>% rename(Freq = "cross_table.Freq") %>% rename(Participant_Type2 = "cross_table.protocol_0037_past_year.Participant_Type2") %>% 
  rename(Protocol = "cross_table.protocol_0037_past_year.Protocol_Type") %>% 
  select(Participant_Type2, Protocol, Freq)
eval_visit <- reshape(protocol_table, idvar = "Participant_Type2", timevar = "Protocol", direction = "wide") %>% mutate_all(as.character)
eval_visit <- na_if(eval_visit,  "<NA>")

protocol_table_gender <- ctable(protocol_0037_past_year$Protocol_Type, protocol_0037_past_year$SEX, 
                  useNA = "always", prop="r", totals=FALSE, display.type=FALSE) %>% 
  as.data.frame() %>% rename(Freq = "cross_table.Freq") %>% rename(SEX = "cross_table.protocol_0037_past_year.SEX") %>% 
  rename(Protocol = "cross_table.protocol_0037_past_year.Protocol_Type") %>% select(Protocol, SEX, Freq)
eval_visit_gender <- reshape(protocol_table_gender, idvar = "SEX", timevar = "Protocol", direction = "wide") %>% mutate_all(as.character)
eval_visit_gender <- na_if(eval_visit_gender,  "<NA>")

protocol_table_race <- ctable(protocol_0037_past_year$Protocol_Type, protocol_0037_past_year$p_demo_screen_background_race, 
                  useNA = "always", prop="r", totals=FALSE, display.type=FALSE) %>% 
  as.data.frame() %>% rename(Freq = "cross_table.Freq") %>% rename(Race = "cross_table.protocol_0037_past_year.p_demo_screen_background_race") %>% 
  rename(Protocol = "cross_table.protocol_0037_past_year.Protocol_Type") %>% select(Protocol, Race, Freq)
eval_visit_race <- reshape(protocol_table_race, idvar = "Race", timevar = "Protocol", direction = "wide") %>% mutate_all(as.character)
eval_visit_race <- na_if(eval_visit_race,  "<NA>")
eval_visit_race$Race <- toupper(eval_visit_race$Race)

protocol_table_hisp <- ctable(protocol_0037_past_year$Protocol_Type, protocol_0037_past_year$p_demo_screen_background_hispanic, 
                  useNA = "always", prop="r", totals=FALSE, display.type=FALSE) %>% 
  as.data.frame() %>% rename(Freq = "cross_table.Freq") %>% rename(Hispanic = "cross_table.protocol_0037_past_year.p_demo_screen_background_hispanic") %>% 
  rename(Protocol = "cross_table.protocol_0037_past_year.Protocol_Type") %>% select(Protocol, Hispanic, Freq)
eval_visit_hisp <- reshape(protocol_table_hisp, idvar = "Hispanic", timevar = "Protocol", direction = "wide") %>% mutate_all(as.character)
eval_visit_hisp <- na_if(eval_visit_hisp,  "<NA>")
eval_visit_hisp$Hispanic <- toupper(eval_visit_hisp$Hispanic)

######## Participants in the past year (screens)

all_screens_past_year <- merge.default(protocol_0037_past_year, econsent_0037_past_year, all = TRUE)
all_screens_past_year <- all_screens_past_year %>% mutate(Parent_screen = (as.numeric(Parent_e_consented) + as.numeric(Parent_DAWBA_completed)), 
  Child_screen = (as.numeric(Child_e_assented) + as.numeric(Child_DAWBA_completed)))
all_screens_past_year$Participant_Type2 <- replace_na(all_screens_past_year$Participant_Type2, "UNSURE")

screening_table_child <- ctable(all_screens_past_year$Participant_Type2, all_screens_past_year$Child_screen, 
                  useNA = "always", prop="r", totals=FALSE, display.type=FALSE) %>% 
  as.data.frame() %>% rename(Freq = "cross_table.Freq") %>% rename(Child_screen = "cross_table.all_screens_past_year.Child_screen") %>% 
  rename(Participant_Type2 = "cross_table.all_screens_past_year.Participant_Type2") %>% 
  select(Participant_Type2, Child_screen, Freq)
screening_child <- reshape(screening_table_child, idvar = "Participant_Type2", timevar = "Child_screen", direction = "wide") %>% mutate_all(as.character)
screening_child <- na_if(screening_child,  "<NA>")

screening_table_parent <- ctable(all_screens_past_year$Participant_Type2, all_screens_past_year$Parent_screen, 
                  useNA = "always", prop="r", totals=FALSE, display.type=FALSE) %>% 
  as.data.frame() %>% rename(Freq = "cross_table.Freq") %>% rename(Parent_screen = "cross_table.all_screens_past_year.Parent_screen") %>% 
  rename(Participant_Type2 = "cross_table.all_screens_past_year.Participant_Type2") %>% 
  select(Participant_Type2, Parent_screen, Freq)
screening_parent <- reshape(screening_table_parent, idvar = "Participant_Type2", timevar = "Parent_screen", direction = "wide") %>% mutate_all(as.character)
screening_parent <- na_if(screening_parent,  "<NA>")

```

***

#### Screening

Child screening status

```{r echo=FALSE, warning=FALSE, message=FALSE}

screening_child %>% 
  kable(., col.names = c("Diagnosis", "Did not e-assent*", "E-assented only", "E-assented + completed DAWBA", "Information Missing", "Total")) %>% 
  kable_styling(position = "left", bootstrap_options = c("striped", "hover", "condensed"))

```

*Did not e-assent = referral that did not actually begin our screening process, for whatever reason (unresponsive, etc.)

Parent screening status

```{r echo=FALSE, warning=FALSE, message=FALSE}

screening_parent %>% 
  kable(., col.names = c("Diagnosis", "Did not e-consent*", "E-consented only", "E-assented + completed DAWBA", "Information Missing", "Total")) %>% 
  kable_styling(position = "left", bootstrap_options = c("striped", "hover", "condensed"))

```

*Did not e-consent = referral that did not actually begin our screening process, for whatever reason (unresponsive, etc.)

***

#### Evaluations

Had in person (or virtual) evaluation visit

```{r echo=FALSE, warning=FALSE, message=FALSE}

eval_visit %>% 
  kable(., col.names = c("Diagnosis", "Signed into Characterization", "Signed Screening Consents Only", "Information Missing", "Total")) %>% 
  kable_styling(position = "left", bootstrap_options = c("striped", "hover", "condensed"))

```

Sex/gender breakdown of these participants: 

```{r echo=FALSE, warning=FALSE, message=FALSE}

eval_visit_gender %>% 
  kable(., col.names = c("Sex", "Signed into Characterization", "Signed Screening Consents Only", "Information Missing", "Total")) %>% 
  kable_styling(position = "left", bootstrap_options = c("striped", "hover", "condensed"))

```

Race/ethnicity breakdown of these participants: 

```{r echo=FALSE, warning=FALSE, message=FALSE}

eval_visit_race %>% 
  kable(., col.names = c("Race/ethnicity", "Signed into Characterization", "Signed Screening Consents Only", "Information Missing", "Total")) %>% 
  kable_styling(position = "left", bootstrap_options = c("striped", "hover", "condensed"))

```

Are they of Hispanic/Latino origin: 

```{r echo=FALSE, warning=FALSE, message=FALSE}

eval_visit_hisp %>% 
  kable(., col.names = c("Hispanic/Latino", "Signed into Characterization", "Signed Screening Consents Only", "Information Missing", "Total")) %>% 
  kable_styling(position = "left", bootstrap_options = c("striped", "hover", "condensed"))

```

***

##### Overall:

Since beginning of protocol 

```{r echo=FALSE, warning=FALSE, message=FALSE, results="hide" }

######################## had eval
# latest visit

protocol_0037_latest <- master_IRTA_latest %>% filter(str_detect(Protocol, "0037")) %>% group_by(Initials) %>% 
  slice(n()) %>% ungroup() %>% select(Initials, SDAN, PLUSID, IRTA_tracker, Participant_Type2, SEX, 
    Eligible, Eligibility_notes, 
    Clinical_Visit_Type, Clinical_Visit_Date, 
    Consent_Date, Protocol, 
    Referral_Date, Screening_Start_Date, 
    Parent_e_consented, Parent2_e_consented, Child_e_assented, 
    DAWBA_completed, Parent_DAWBA_completed, Child_DAWBA_completed) %>% 
  filter(Participant_Type2=="MDD" | Participant_Type2=="HV") %>% mutate(Protocol_Type = NA)

protocol_0037_latest$Protocol_Type[str_detect(protocol_0037_latest$Protocol, 'SCREENING')] <- 'Screening'
protocol_0037_latest$Protocol_Type[str_detect(protocol_0037_latest$Protocol, 'Screening')] <- 'Screening'
protocol_0037_latest$Protocol_Type[is.na(protocol_0037_latest$Protocol_Type)] <- 'Characterization'
fill_in <- c("Parent_e_consented", "Parent2_e_consented", "Child_e_assented", "DAWBA_completed", "Parent_DAWBA_completed", "Child_DAWBA_completed")
protocol_0037_latest[fill_in] <- lapply(protocol_0037_latest[fill_in], replace_na, "1")

protocol_0037_latest$Overall_date <- coalesce(protocol_0037_latest$Clinical_Visit_Date, protocol_0037_latest$Screening_Start_Date) %>% 
  coalesce(., protocol_0037_latest$Referral_Date) %>% as.Date()
protocol_0037_latest <- left_join(protocol_0037_latest, demo)

# The data we need  --------------------------------------------

######## Participants in the past year (evals)

protocol_table_overall <- ctable(protocol_0037_latest$Participant_Type2, protocol_0037_latest$Protocol_Type, 
                  useNA = "always", prop="r", totals=FALSE, display.type=FALSE) %>% 
  as.data.frame() %>% rename(Freq = "cross_table.Freq") %>% rename(Participant_Type2 = "cross_table.protocol_0037_latest.Participant_Type2") %>% 
  rename(Protocol = "cross_table.protocol_0037_latest.Protocol_Type") %>% 
  select(Participant_Type2, Protocol, Freq)
eval_visit_overall <- reshape(protocol_table_overall, idvar = "Participant_Type2", timevar = "Protocol", direction = "wide") %>% mutate_all(as.character)
eval_visit_overall <- na_if(eval_visit_overall,  "<NA>")

protocol_table_gender_overall <- ctable(protocol_0037_latest$Protocol_Type, protocol_0037_latest$SEX, 
                  useNA = "always", prop="r", totals=FALSE, display.type=FALSE) %>% 
  as.data.frame() %>% rename(Freq = "cross_table.Freq") %>% rename(SEX = "cross_table.protocol_0037_latest.SEX") %>% 
  rename(Protocol = "cross_table.protocol_0037_latest.Protocol_Type") %>% select(Protocol, SEX, Freq)
eval_visit_gender_overall <- reshape(protocol_table_gender_overall, idvar = "SEX", timevar = "Protocol", direction = "wide") %>% mutate_all(as.character)
eval_visit_gender_overall <- na_if(eval_visit_gender_overall,  "<NA>")

protocol_table_race_overall <- ctable(protocol_0037_latest$Protocol_Type, protocol_0037_latest$p_demo_screen_background_race, 
                  useNA = "always", prop="r", totals=FALSE, display.type=FALSE) %>% 
  as.data.frame() %>% rename(Freq = "cross_table.Freq") %>% rename(Race = "cross_table.protocol_0037_latest.p_demo_screen_background_race") %>% 
  rename(Protocol = "cross_table.protocol_0037_latest.Protocol_Type") %>% select(Protocol, Race, Freq)
eval_visit_race_overall <- reshape(protocol_table_race_overall, idvar = "Race", timevar = "Protocol", direction = "wide") %>% mutate_all(as.character)
eval_visit_race_overall <- na_if(eval_visit_race_overall,  "<NA>")
eval_visit_race_overall$Race <- toupper(eval_visit_race_overall$Race)

protocol_table_hisp_overall <- ctable(protocol_0037_latest$Protocol_Type, protocol_0037_latest$p_demo_screen_background_hispanic, 
                  useNA = "always", prop="r", totals=FALSE, display.type=FALSE) %>% 
  as.data.frame() %>% rename(Freq = "cross_table.Freq") %>% rename(Hispanic = "cross_table.protocol_0037_latest.p_demo_screen_background_hispanic") %>% 
  rename(Protocol = "cross_table.protocol_0037_latest.Protocol_Type") %>% select(Protocol, Hispanic, Freq)
eval_visit_hisp_overall <- reshape(protocol_table_hisp_overall, idvar = "Hispanic", timevar = "Protocol", direction = "wide") %>% mutate_all(as.character)
eval_visit_hisp_overall <- na_if(eval_visit_hisp_overall,  "<NA>")
eval_visit_hisp_overall$Hispanic <- toupper(eval_visit_hisp_overall$Hispanic)

######## Current eligibility of all enrolled 

current_eligibility <- protocol_0037_latest %>% filter(Protocol_Type=="Characterization") 
current_eligibility_table <- ctable(current_eligibility$Participant_Type2, current_eligibility$Eligible, 
  useNA = "always", prop="r", totals=FALSE, display.type=FALSE) %>% as.data.frame() %>% 
  rename(Freq = "cross_table.Freq") %>% rename(Eligible = "cross_table.current_eligibility.Eligible") %>% 
  rename(Participant_Type2 = "cross_table.current_eligibility.Participant_Type2") %>% select(Participant_Type2, Eligible, Freq)
current_eligibility_table2 <- reshape(current_eligibility_table, idvar = "Eligible", timevar = "Participant_Type2", direction = "wide") %>% 
  cbind(., order=c(1, 2, 11, 3, 4, 5, 6, 7, 8, 9, 10, 12, 13)) %>% arrange(order) %>% select(-order) %>% mutate_all(as.character)

current_eligibility_table2$Eligible <- recode(current_eligibility_table2$Eligible, 
  "0"="Include", 
  "1"="Include: can’t scan (braces, etc.)", 
  "2"="On hold: contact again after specified amount of time", 
  "3"="On hold: low priority", 
  "4"="Excluded: cannot be reached or scheduled, all contact options exhausted", 
  "5"="Excluded: does not meet criteria",
  "6"="Excluded: meets exclusionary criteria (substance use, psychosis, etc.)",
  "7"="Did not or withdrew assent/consent", 
  "8"="Ruled as ineligible for treatment during baseline assessment",
  "9"="Patient (or parent) withdrew from treatment", 
  "10"="Excluded after commencing treatment: clinician decision", 
  "Total"="Total", .missing = NULL)

######## Participants in the past year (screens)

all_screens <- merge.default(protocol_0037_latest, econsent_0037_combined, all = TRUE)
all_screens <- all_screens %>% mutate(Parent_screen = (as.numeric(Parent_e_consented) + as.numeric(Parent_DAWBA_completed)), 
  Child_screen = (as.numeric(Child_e_assented) + as.numeric(Child_DAWBA_completed)))
all_screens$Participant_Type2 <- replace_na(all_screens$Participant_Type2, "UNSURE")

screening_table_child_overall <- ctable(all_screens$Participant_Type2, all_screens$Child_screen, 
                  useNA = "always", prop="r", totals=FALSE, display.type=FALSE) %>% 
  as.data.frame() %>% rename(Freq = "cross_table.Freq") %>% rename(Child_screen = "cross_table.all_screens.Child_screen") %>% 
  rename(Participant_Type2 = "cross_table.all_screens.Participant_Type2") %>% 
  select(Participant_Type2, Child_screen, Freq)
screening_child_overall <- reshape(screening_table_child_overall, idvar = "Participant_Type2", timevar = "Child_screen", direction = "wide") %>% 
  mutate_all(as.character)
screening_child_overall <- na_if(screening_child_overall,  "<NA>")

screening_table_parent_overall <- ctable(all_screens$Participant_Type2, all_screens$Parent_screen, 
                  useNA = "always", prop="r", totals=FALSE, display.type=FALSE) %>% 
  as.data.frame() %>% rename(Freq = "cross_table.Freq") %>% rename(Parent_screen = "cross_table.all_screens.Parent_screen") %>% 
  rename(Participant_Type2 = "cross_table.all_screens.Participant_Type2") %>% 
  select(Participant_Type2, Parent_screen, Freq)
screening_parent_overall <- reshape(screening_table_parent_overall, idvar = "Participant_Type2", timevar = "Parent_screen", direction = "wide") %>% 
  mutate_all(as.character)
screening_parent_overall <- na_if(screening_parent_overall,  "<NA>")

```

***

#### Screening

Child screening status

```{r echo=FALSE, warning=FALSE, message=FALSE}

screening_child_overall %>% 
  kable(., col.names = c("Diagnosis", "Did not e-assent*", "E-assented only", "E-assented + completed DAWBA", "Information Missing", "Total")) %>% 
  kable_styling(position = "left", bootstrap_options = c("striped", "hover", "condensed"))

```

*Did not e-assent = referral that did not actually begin our screening process, for whatever reason (unresponsive, etc.)

Parent screening status

```{r echo=FALSE, warning=FALSE, message=FALSE}

screening_parent_overall %>% 
  kable(., col.names = c("Diagnosis", "Did not e-consent*", "E-consented only", "E-assented + completed DAWBA", "Information Missing", "Total")) %>% 
  kable_styling(position = "left", bootstrap_options = c("striped", "hover", "condensed"))

```

*Did not e-consent = referral that did not actually begin our screening process, for whatever reason (unresponsive, etc.)

***

#### Evaluations

Had in person (or virtual) evaluation visit

```{r echo=FALSE, warning=FALSE, message=FALSE}

eval_visit_overall %>% 
  kable(., col.names = c("Diagnosis", "Signed into Characterization", "Signed Screening Consents Only", "Information Missing", "Total")) %>% 
  kable_styling(position = "left", bootstrap_options = c("striped", "hover", "condensed"))

```

Sex/gender breakdown of these participants: 

```{r echo=FALSE, warning=FALSE, message=FALSE}

eval_visit_gender_overall %>% 
  kable(., col.names = c("Sex", "Signed into Characterization", "Signed Screening Consents Only", "Information Missing", "Total")) %>% 
  kable_styling(position = "left", bootstrap_options = c("striped", "hover", "condensed"))

```

Race/ethnicity breakdown of these participants: 

```{r echo=FALSE, warning=FALSE, message=FALSE}

eval_visit_race_overall %>% 
  kable(., col.names = c("Race/ethnicity", "Signed into Characterization", "Signed Screening Consents Only", "Information Missing", "Total")) %>% 
  kable_styling(position = "left", bootstrap_options = c("striped", "hover", "condensed"))

```

Are they of Hispanic/Latino origin: 

```{r echo=FALSE, warning=FALSE, message=FALSE}

eval_visit_hisp_overall %>% 
  kable(., col.names = c("Hispanic/Latino", "Signed into Characterization", "Signed Screening Consents Only", "Information Missing", "Total")) %>% 
  kable_styling(position = "left", bootstrap_options = c("striped", "hover", "condensed"))

```

***

Current eligibility status in characterization

```{r echo=FALSE, warning=FALSE, message=FALSE}

current_eligibility_table2 %>% select(-`Freq.<NA>`) %>% 
  kable(., col.names = c("Enrollment status", "HV", "MDD", "Total")) %>%
  kable_styling(position = "left", bootstrap_options = c("striped", "hover", "condensed"))

```

***
