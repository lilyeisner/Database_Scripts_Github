---
title: "CRISIS dataset"
output: 
  html_document:
    df_print: paged
  word_document:
    fig_caption: yes
    fig_height: 5
    fig_width: 8
header-includes:
- \usepackage{booktabs}
- \usepackage{longtable}
- \usepackage{array}
- \usepackage{multirow}
- \usepackage{wrapfig}
- \usepackage{float}
- \usepackage{colortbl}
- \usepackage{pdflscape}
- \usepackage{tabu}
- \usepackage{threeparttable}
- \usepackage{threeparttablex}
- \usepackage[normalem]{ulem}
- \usepackage{makecell}
- \usepackage{xcolor}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# !diagnostics off
```

```{r echo=FALSE, warning=FALSE, message=FALSE, results="hide" }

# Loading data ------------------------------------------------------------

todays_date <- todays_date_formatted %>% format(., "%B %d %Y")

if (exists("Psychometrics_treatment")==FALSE) {
        master_database_file <- list.files(path = paste0(database_location), pattern = "^MASTER_DATABASE_CLINICAL", all.files = FALSE,
                                 full.names = FALSE, recursive = FALSE, ignore.case = FALSE, include.dirs = FALSE, no.. = FALSE)
        master_database_file_time <- file.mtime(paste0(database_location, "/", master_database_file)) %>% as.Date()
        master_database_combined <- tibble(File=c(master_database_file), Date=c(master_database_file_time)) %>% 
          arrange(desc(Date)) %>% slice(1)
        Psychometrics_treatment <- read_excel(paste0(database_location, master_database_combined[1]))
        rm(master_database_file, master_database_file_time, master_database_combined)
} else {
        print("clinical database info already imported")
}

date_variables <- Psychometrics_treatment %>% select(matches("_date"), matches("_Date")) %>% colnames()
Psychometrics_treatment[date_variables] <- lapply(Psychometrics_treatment[date_variables], as.Date)

if (exists("Psychometrics_behav")==FALSE) {
        master_database_file <- list.files(path = paste0(database_location), pattern = "^MASTER_DATABASE_BEHAVIOURAL", all.files = FALSE,
                                 full.names = FALSE, recursive = FALSE, ignore.case = FALSE, include.dirs = FALSE, no.. = FALSE)
        master_database_file_time <- file.mtime(paste0(database_location, "/", master_database_file)) %>% as.Date()
        master_database_combined <- tibble(File=c(master_database_file), Date=c(master_database_file_time)) %>% 
          arrange(desc(Date)) %>% slice(1)
        Psychometrics_behav <- read_excel(paste0(database_location, master_database_combined[1]))
        rm(master_database_file, master_database_file_time, master_database_combined)
} else {
        print("tasks database info already imported")
}

date_variables <- Psychometrics_behav %>% select(matches("_date"), matches("_Date")) %>% colnames()
Psychometrics_behav[date_variables] <- lapply(Psychometrics_behav[date_variables], as.Date)

if (exists("MMI_recovery_combined2")==FALSE) {
        mmi_recovery_file <- list.files(path = paste0(database_location, "COVID19/"), pattern = "^MMI_recovery_subset", all.files = FALSE,
                                 full.names = FALSE, recursive = FALSE, ignore.case = FALSE, include.dirs = FALSE, no.. = FALSE)
        mmi_recovery_file_time <- file.mtime(paste0(database_location, "COVID19/", mmi_recovery_file)) %>% as.Date()
        mmi_recovery_combined <- tibble(File=c(mmi_recovery_file), Date=c(mmi_recovery_file_time)) %>% 
          arrange(desc(Date)) %>% slice(1)
        MMI_recovery_combined2 <- read_excel(paste0(database_location, "COVID19/", mmi_recovery_combined[1]))
} else {
        print("MMI recovery completion info already imported")
}

# crisis recruitment related
# child_contacted <- c(to_change$child_contacted)
# parent_contacted <- c(to_change$parent_contacted)
# parent_agreed <- c(to_change$parent_agreed)

```

![](`r paste0(CBT_location, "images/NIH_logo.png")`)

***

#### CRISIS data flow

***

##### DATE: `r todays_date`

```{r echo=FALSE, warning=FALSE, message=FALSE, results="hide" }

measures_completed <- Psychometrics_behav %>% filter(str_detect(Task_Name, "easures")) %>% filter(Task_Date >= "2020-04-06") %>% 
  select(Initials, SDAN, PLUSID, Participant_Type2, IRTA_tracker, Task_Name, Task_Date, SEX, Age_at_visit,
         c_ksadsdx_primary_dx, c_ksadsdx_dx_detailed, s_mfq1w_tot, s_mfq1w_date, s_mfq_tot, s_mfq_date, s_scared_tot, s_scared_date, 
         s_scaredshort_tot, s_scaredshort_date, matches("s_crisis_"), p_mfq1w_tot, p_mfq1w_date, p_mfq_tot, p_mfq_date, p_scared_tot, 
         p_scared_date, p_scaredshort_tot, p_scaredshort_date, matches("p_crisis_")) %>% rename(Age = "Age_at_visit") %>%
  group_by(Initials) %>% mutate(id = row_number()) %>% ungroup() %>% mutate(id = (id + 2)) %>% mutate(Age = round(Age, digits = 0))
measures_completed$s_mfq_tot <- coalesce(measures_completed$s_mfq_tot, measures_completed$s_mfq1w_tot) %>% round(., digits = 0)
measures_completed$p_mfq_tot <- coalesce(measures_completed$p_mfq_tot, measures_completed$p_mfq1w_tot) %>% round(., digits = 0)
measures_completed$s_mfq_date <- coalesce(measures_completed$s_mfq_date, measures_completed$s_mfq1w_date) %>% round(., digits = 0)
measures_completed$p_mfq_date <- coalesce(measures_completed$p_mfq_date, measures_completed$p_mfq1w_date) %>% round(., digits = 0)
measures_completed <- measures_completed %>% select(-s_mfq1w_tot, -p_mfq1w_tot, -s_mfq1w_date, -p_mfq1w_date)

```

```{r echo=FALSE, warning=FALSE, message=FALSE, results="hide" }

# total contacted 
# child_contacted <- 173
# parent_contacted <- 125
# total agreed to participate 

child_agreed <- 166
parent_agreed <- 126

##### all baseline measures completed 
# parent
parent_completed_all_base <- measures_completed %>% filter(!is.na(p_crisis_base_tot)) %>% group_by(Initials) %>% arrange(Initials, Task_Date) %>% 
  slice(1) %>% ungroup() %>% select(Initials, p_mfq_tot, p_scaredshort_tot, p_crisis_base_tot) %>% filter(!is.na(p_mfq_tot) & !is.na(p_scaredshort_tot)) 
parent_completed_all_base_num <- parent_completed_all_base %>% nrow() %>% as.numeric()
# child 
child_completed_all_base <- measures_completed %>% filter(!is.na(s_crisis_base_tot)) %>% group_by(Initials) %>% arrange(Initials, Task_Date) %>% 
  slice(1) %>% ungroup() %>% select(Initials, s_mfq_tot, s_scaredshort_tot, s_crisis_base_tot) %>% filter(!is.na(s_mfq_tot) & !is.na(s_scaredshort_tot))
child_completed_all_base_num <- child_completed_all_base %>% nrow() %>% as.numeric()
##### crisis baseline completed 
# parent
parent_completed_crisis_base <- measures_completed %>% filter(!is.na(p_crisis_base_tot)) %>% group_by(Initials) %>% arrange(Initials, Task_Date) %>% 
  slice(1) %>% ungroup() %>% select(Initials, p_crisis_base_tot)
parent_completed_crisis_base_num <- parent_completed_crisis_base %>% nrow() %>% as.numeric()
# child 
child_completed_crisis_base <- measures_completed %>% filter(!is.na(s_crisis_base_tot)) %>% group_by(Initials) %>% arrange(Initials, Task_Date) %>% 
  slice(1) %>% ungroup() %>% select(Initials, s_crisis_base_tot)
child_completed_crisis_base_num <- child_completed_crisis_base %>% nrow() %>% as.numeric()

##### all followup measures completed (first follow up)
# parent
parent_completed_all_fu1 <- measures_completed %>% filter(!is.na(p_crisis_fu_tot)) %>% group_by(Initials) %>% arrange(Initials, Task_Date) %>% 
  slice(1) %>% ungroup() %>% select(Initials, p_mfq_tot, p_scaredshort_tot, p_crisis_fu_tot) %>% filter(!is.na(p_mfq_tot) & !is.na(p_scaredshort_tot))
parent_completed_all_fu_num1 <- parent_completed_all_fu1 %>% nrow() %>% as.numeric() 
# child 
child_completed_all_fu1 <- measures_completed %>% filter(!is.na(s_crisis_fu_tot)) %>% group_by(Initials) %>% arrange(Initials, Task_Date) %>% 
  slice(1) %>% ungroup() %>% select(Initials, s_mfq_tot, s_scaredshort_tot, s_crisis_fu_tot) %>% filter(!is.na(s_mfq_tot) & !is.na(s_scaredshort_tot))
child_completed_all_fu_num1 <- child_completed_all_fu1 %>% nrow() %>% as.numeric() 
##### crisis followup completed 
# parent
parent_completed_crisis_fu1 <- measures_completed %>% filter(!is.na(p_crisis_fu_tot)) %>% group_by(Initials) %>% arrange(Initials, Task_Date) %>% 
  slice(1) %>% ungroup() %>% select(Initials, p_crisis_fu_tot)
parent_completed_crisis_fu_num1 <- parent_completed_crisis_fu1 %>% nrow() %>% as.numeric() 
# child 
child_completed_crisis_fu1 <- measures_completed %>% filter(!is.na(s_crisis_fu_tot)) %>% group_by(Initials) %>% arrange(Initials, Task_Date) %>% 
  slice(1) %>% ungroup() %>% select(Initials, s_crisis_fu_tot)
child_completed_crisis_fu_num1 <- child_completed_crisis_fu1 %>% nrow() %>% as.numeric() 
##### all followup measures completed (second follow up)
# parent
parent_completed_all_fu2 <- measures_completed %>% filter(!is.na(p_crisis_fu_tot)) %>% group_by(Initials) %>% arrange(Initials, Task_Date) %>% filter(n()>1) %>% 
  slice(2) %>% ungroup() %>% select(Initials, p_mfq_tot, p_scaredshort_tot, p_crisis_fu_tot) %>% filter(!is.na(p_mfq_tot) & !is.na(p_scaredshort_tot))
parent_completed_all_fu_num2 <- parent_completed_all_fu2 %>% nrow() %>% as.numeric() 
# child 
child_completed_all_fu2 <- measures_completed %>% filter(!is.na(s_crisis_fu_tot)) %>% group_by(Initials) %>% arrange(Initials, Task_Date) %>% filter(n()>1) %>% 
  slice(2) %>% ungroup() %>% select(Initials, s_mfq_tot, s_scaredshort_tot, s_crisis_fu_tot) %>% filter(!is.na(s_mfq_tot) & !is.na(s_scaredshort_tot))
child_completed_all_fu_num2 <- child_completed_all_fu2 %>% nrow() %>% as.numeric() 
##### crisis followup completed 
# parent
parent_completed_crisis_fu2 <- measures_completed %>% filter(!is.na(p_crisis_fu_tot)) %>% group_by(Initials) %>% arrange(Initials, Task_Date) %>% filter(n()>1) %>% 
  slice(2) %>% ungroup() %>% select(Initials, p_crisis_fu_tot)
parent_completed_crisis_fu_num2 <- parent_completed_crisis_fu2 %>% nrow() %>% as.numeric() 
# child 
child_completed_crisis_fu2 <- measures_completed %>% filter(!is.na(s_crisis_fu_tot)) %>% group_by(Initials) %>% arrange(Initials, Task_Date) %>% filter(n()>1) %>% 
  slice(2) %>% ungroup() %>% select(Initials, s_crisis_fu_tot)
child_completed_crisis_fu_num2 <- child_completed_crisis_fu2 %>% nrow() %>% as.numeric() 
##### all followup measures completed (third follow up)
# parent
parent_completed_all_fu3 <- measures_completed %>% filter(!is.na(p_crisis_fu_tot)) %>% group_by(Initials) %>% arrange(Initials, Task_Date) %>% filter(n()>2) %>% 
  slice(3) %>% ungroup() %>% select(Initials, p_mfq_tot, p_scaredshort_tot, p_crisis_fu_tot) %>% filter(!is.na(p_mfq_tot) & !is.na(p_scaredshort_tot))
parent_completed_all_fu_num3 <- parent_completed_all_fu3 %>% nrow() %>% as.numeric() 
# child 
child_completed_all_fu3 <- measures_completed %>% filter(!is.na(s_crisis_fu_tot)) %>% group_by(Initials) %>% arrange(Initials, Task_Date) %>% filter(n()>2) %>% 
  slice(3) %>% ungroup() %>% select(Initials, s_mfq_tot, s_scaredshort_tot, s_crisis_fu_tot) %>% filter(!is.na(s_mfq_tot) & !is.na(s_scaredshort_tot))
child_completed_all_fu_num3 <- child_completed_all_fu3 %>% nrow() %>% as.numeric() 
##### crisis followup completed 
# parent
parent_completed_crisis_fu3 <- measures_completed %>% filter(!is.na(p_crisis_fu_tot)) %>% group_by(Initials) %>% arrange(Initials, Task_Date) %>% filter(n()>2) %>% 
  slice(3) %>% ungroup() %>% select(Initials, p_crisis_fu_tot)
parent_completed_crisis_fu_num3 <- parent_completed_crisis_fu3 %>% nrow() %>% as.numeric() 
# child 
child_completed_crisis_fu3 <- measures_completed %>% filter(!is.na(s_crisis_fu_tot)) %>% group_by(Initials) %>% arrange(Initials, Task_Date) %>% filter(n()>2) %>% 
  slice(3) %>% ungroup() %>% select(Initials, s_crisis_fu_tot)
child_completed_crisis_fu_num3 <- child_completed_crisis_fu3 %>% nrow() %>% as.numeric() 
##### all followup measures completed (forth follow up)
# parent
parent_completed_all_fu4 <- measures_completed %>% filter(!is.na(p_crisis_fu_tot)) %>% group_by(Initials) %>% arrange(Initials, Task_Date) %>% filter(n()>3) %>% 
  slice(4) %>% ungroup() %>% select(Initials, p_mfq_tot, p_scaredshort_tot, p_crisis_fu_tot) %>% filter(!is.na(p_mfq_tot) & !is.na(p_scaredshort_tot))
parent_completed_all_fu_num4 <- parent_completed_all_fu4 %>% nrow() %>% as.numeric() 
# child 
child_completed_all_fu4 <- measures_completed %>% filter(!is.na(s_crisis_fu_tot)) %>% group_by(Initials) %>% arrange(Initials, Task_Date) %>% filter(n()>3) %>% 
  slice(4) %>% ungroup() %>% select(Initials, s_mfq_tot, s_scaredshort_tot, s_crisis_fu_tot) %>% filter(!is.na(s_mfq_tot) & !is.na(s_scaredshort_tot))
child_completed_all_fu_num4 <- child_completed_all_fu4 %>% nrow() %>% as.numeric() 
##### crisis followup completed 
# parent
parent_completed_crisis_fu4 <- measures_completed %>% filter(!is.na(p_crisis_fu_tot)) %>% group_by(Initials) %>% arrange(Initials, Task_Date) %>% filter(n()>3) %>% 
  slice(4) %>% ungroup() %>% select(Initials, p_crisis_fu_tot)
parent_completed_crisis_fu_num4 <- parent_completed_crisis_fu4 %>% nrow() %>% as.numeric() 
# child 
child_completed_crisis_fu4 <- measures_completed %>% filter(!is.na(s_crisis_fu_tot)) %>% group_by(Initials) %>% arrange(Initials, Task_Date) %>% filter(n()>3) %>% 
  slice(4) %>% ungroup() %>% select(Initials, s_crisis_fu_tot)
child_completed_crisis_fu_num4 <- child_completed_crisis_fu4 %>% nrow() %>% as.numeric() 

##### crisis baseline + followup completed, all measures (first follow up)
# parent
parent_completed_all_fu1 <- parent_completed_all_fu1 %>% rename(p_mfq_fu_tot="p_mfq_tot") %>% rename(p_scaredshort_fu_tot="p_scaredshort_tot")
parent_completed_all_both1 <- merge.default(parent_completed_all_base, parent_completed_all_fu1, all=TRUE) %>% 
  filter(!is.na(p_crisis_base_tot)) %>% filter(!is.na(p_crisis_fu_tot))
parent_completed_all_both_num1 <- parent_completed_all_both1 %>% nrow() %>% as.numeric() 
# child 
child_completed_all_fu1 <- child_completed_all_fu1 %>% rename(s_mfq_fu_tot="s_mfq_tot") %>% rename(s_scaredshort_fu_tot="s_scaredshort_tot")
child_completed_all_both1 <- merge.default(child_completed_all_base, child_completed_all_fu1, all=TRUE) %>% 
  filter(!is.na(s_crisis_base_tot)) %>% filter(!is.na(s_crisis_fu_tot))
child_completed_all_both_num1 <- child_completed_all_both1 %>% nrow() %>% as.numeric() 
##### crisis baseline + followup completed, crisis only
# parent
parent_completed_crisis_both1 <- merge.default(parent_completed_crisis_base, parent_completed_crisis_fu1, all=TRUE) %>%
  filter(!is.na(p_crisis_fu_tot)) %>% filter(!is.na(p_crisis_base_tot)) 
parent_completed_crisis_both_num1 <- parent_completed_crisis_both1 %>% nrow() %>% as.numeric() 
# child 
child_completed_crisis_both1 <- merge.default(child_completed_crisis_base, child_completed_crisis_fu1, all=TRUE) %>% 
  filter(!is.na(s_crisis_fu_tot)) %>% filter(!is.na(s_crisis_base_tot))
child_completed_crisis_both_num1 <- child_completed_crisis_both1 %>% nrow() %>% as.numeric() 
##### crisis baseline + followup completed, all measures (second follow up)
# parent
parent_completed_all_fu2 <- parent_completed_all_fu2 %>% rename(p_mfq_fu2_tot="p_mfq_tot") %>% rename(p_scaredshort_fu2_tot="p_scaredshort_tot") %>% 
  rename(p_crisis_fu2_tot="p_crisis_fu_tot")
parent_completed_all_both2 <- merge.default(parent_completed_all_both1, parent_completed_all_fu2, all=TRUE) %>%
  filter(!is.na(p_crisis_base_tot)) %>% filter(!is.na(p_crisis_fu_tot)) %>% filter(!is.na(p_crisis_fu2_tot))
parent_completed_all_both_num2 <- parent_completed_all_both2 %>% nrow() %>% as.numeric()
# # child 
child_completed_all_fu2 <- child_completed_all_fu2 %>% rename(s_mfq_fu2_tot="s_mfq_tot") %>% rename(s_scaredshort_fu2_tot="s_scaredshort_tot") %>% 
  rename(s_crisis_fu2_tot="s_crisis_fu_tot")
child_completed_all_both2 <- merge.default(child_completed_all_both1, child_completed_all_fu2, all=TRUE) %>%
  filter(!is.na(s_crisis_base_tot)) %>% filter(!is.na(s_crisis_fu_tot)) %>% filter(!is.na(s_crisis_fu2_tot))
child_completed_all_both_num2 <- child_completed_all_both2 %>% nrow() %>% as.numeric()
##### crisis baseline + followup completed, crisis only
# parent
parent_completed_crisis_fu2 <- parent_completed_crisis_fu2 %>% rename(p_crisis_fu2_tot="p_crisis_fu_tot")
parent_completed_crisis_both2 <- merge.default(parent_completed_crisis_both1, parent_completed_crisis_fu2, all=TRUE) %>%
  filter(!is.na(p_crisis_fu_tot)) %>% filter(!is.na(p_crisis_fu2_tot))
parent_completed_crisis_both_num2 <- parent_completed_crisis_both2 %>% nrow() %>% as.numeric()
# child
child_completed_crisis_fu2 <- child_completed_crisis_fu2 %>% rename(s_crisis_fu2_tot="s_crisis_fu_tot")
child_completed_crisis_both2 <- merge.default(child_completed_crisis_both1, child_completed_crisis_fu2, all=TRUE) %>%
  filter(!is.na(s_crisis_fu_tot)) %>% filter(!is.na(s_crisis_fu2_tot))
child_completed_crisis_both_num2 <- child_completed_crisis_both2 %>% nrow() %>% as.numeric()
##### crisis baseline + followup completed, all measures (third follow up)
# parent
parent_completed_all_fu3 <- parent_completed_all_fu3 %>% rename(p_mfq_fu3_tot="p_mfq_tot") %>% rename(p_scaredshort_fu3_tot="p_scaredshort_tot") %>% 
  rename(p_crisis_fu3_tot="p_crisis_fu_tot")
parent_completed_all_both3 <- merge.default(parent_completed_all_both2, parent_completed_all_fu3, all=TRUE) %>%
  filter(!is.na(p_crisis_base_tot)) %>% filter(!is.na(p_crisis_fu_tot)) %>% filter(!is.na(p_crisis_fu3_tot))
parent_completed_all_both_num3 <- parent_completed_all_both3 %>% nrow() %>% as.numeric()
# # child 
child_completed_all_fu3 <- child_completed_all_fu3 %>% rename(s_mfq_fu3_tot="s_mfq_tot") %>% rename(s_scaredshort_fu3_tot="s_scaredshort_tot") %>% 
  rename(s_crisis_fu3_tot="s_crisis_fu_tot")
child_completed_all_both3 <- merge.default(child_completed_all_both2, child_completed_all_fu3, all=TRUE) %>%
  filter(!is.na(s_crisis_base_tot)) %>% filter(!is.na(s_crisis_fu_tot)) %>% filter(!is.na(s_crisis_fu3_tot))
child_completed_all_both_num3 <- child_completed_all_both3 %>% nrow() %>% as.numeric()
##### crisis baseline + followup completed, crisis only
# parent
parent_completed_crisis_fu3 <- parent_completed_crisis_fu3 %>% rename(p_crisis_fu3_tot="p_crisis_fu_tot")
parent_completed_crisis_both3 <- merge.default(parent_completed_crisis_both2, parent_completed_crisis_fu3, all=TRUE) %>%
  filter(!is.na(p_crisis_fu_tot)) %>% filter(!is.na(p_crisis_fu3_tot))
parent_completed_crisis_both_num3 <- parent_completed_crisis_both3 %>% nrow() %>% as.numeric()
# child
child_completed_crisis_fu3 <- child_completed_crisis_fu3 %>% rename(s_crisis_fu3_tot="s_crisis_fu_tot")
child_completed_crisis_both3 <- merge.default(child_completed_crisis_both2, child_completed_crisis_fu3, all=TRUE) %>%
  filter(!is.na(s_crisis_fu_tot)) %>% filter(!is.na(s_crisis_fu3_tot))
child_completed_crisis_both_num3 <- child_completed_crisis_both3 %>% nrow() %>% as.numeric()
##### crisis baseline + followup completed, all measures (forth follow up)
# parent
parent_completed_all_fu4 <- parent_completed_all_fu4 %>% rename(p_mfq_fu4_tot="p_mfq_tot") %>% rename(p_scaredshort_fu4_tot="p_scaredshort_tot") %>% 
  rename(p_crisis_fu4_tot="p_crisis_fu_tot")
parent_completed_all_both4 <- merge.default(parent_completed_all_both2, parent_completed_all_fu4, all=TRUE) %>%
  filter(!is.na(p_crisis_base_tot)) %>% filter(!is.na(p_crisis_fu_tot)) %>% filter(!is.na(p_crisis_fu4_tot))
parent_completed_all_both_num4 <- parent_completed_all_both4 %>% nrow() %>% as.numeric()
# # child 
child_completed_all_fu4 <- child_completed_all_fu4 %>% rename(s_mfq_fu4_tot="s_mfq_tot") %>% rename(s_scaredshort_fu4_tot="s_scaredshort_tot") %>% 
  rename(s_crisis_fu4_tot="s_crisis_fu_tot")
child_completed_all_both4 <- merge.default(child_completed_all_both2, child_completed_all_fu4, all=TRUE) %>%
  filter(!is.na(s_crisis_base_tot)) %>% filter(!is.na(s_crisis_fu_tot)) %>% filter(!is.na(s_crisis_fu4_tot))
child_completed_all_both_num4 <- child_completed_all_both4 %>% nrow() %>% as.numeric()
##### crisis baseline + followup completed, crisis only
# parent
parent_completed_crisis_fu4 <- parent_completed_crisis_fu4 %>% rename(p_crisis_fu4_tot="p_crisis_fu_tot")
parent_completed_crisis_both4 <- merge.default(parent_completed_crisis_both2, parent_completed_crisis_fu4, all=TRUE) %>%
  filter(!is.na(p_crisis_fu_tot)) %>% filter(!is.na(p_crisis_fu4_tot))
parent_completed_crisis_both_num4 <- parent_completed_crisis_both4 %>% nrow() %>% as.numeric()
# child
child_completed_crisis_fu4 <- child_completed_crisis_fu4 %>% rename(s_crisis_fu4_tot="s_crisis_fu_tot")
child_completed_crisis_both4 <- merge.default(child_completed_crisis_both2, child_completed_crisis_fu4, all=TRUE) %>%
  filter(!is.na(s_crisis_fu_tot)) %>% filter(!is.na(s_crisis_fu4_tot))
child_completed_crisis_both_num4 <- child_completed_crisis_both4 %>% nrow() %>% as.numeric()

# combine these
all_table <- tibble(Respondant=c("Parent", "Child"), 
                    # Tot_contacted=c(parent_contacted, child_contacted),
                    Tot_agreed=c(parent_agreed, child_agreed), 
                    ALL_base_completed=c(parent_completed_all_base_num, child_completed_all_base_num), 
                    ALL_fu_completed=c(parent_completed_all_fu_num1, child_completed_all_fu_num1), 
                    ALL_fu2_completed=c(parent_completed_all_fu_num2, child_completed_all_fu_num2),
                    ALL_fu3_completed=c(parent_completed_all_fu_num3, child_completed_all_fu_num3),
                    ALL_fu4_completed=c(parent_completed_all_fu_num4, child_completed_all_fu_num4),
                    ALL_both_completed=c(parent_completed_all_both_num1, child_completed_all_both_num1), 
                    ALL_both2_completed=c(parent_completed_all_both_num2, child_completed_all_both_num2),
                    ALL_both3_completed=c(parent_completed_all_both_num3, child_completed_all_both_num3),
                    ALL_both4_completed=c(parent_completed_all_both_num4, child_completed_all_both_num4)) %>%
  # mutate(Agreed_percent = (Tot_agreed/Tot_contacted)*100) %>% mutate(Agreed_percent=round(Agreed_percent, digits=2)) %>% 
  mutate(All_base_percent = (ALL_base_completed/Tot_agreed)*100) %>%
  mutate(All_fu_percent = (ALL_fu_completed/Tot_agreed)*100) %>% mutate(All_both_percent = (ALL_both_completed/Tot_agreed)*100) %>% 
  mutate(All_fu2_percent = (ALL_fu2_completed/Tot_agreed)*100) %>% mutate(All_both2_percent = (ALL_both2_completed/Tot_agreed)*100) %>% 
  mutate(All_fu3_percent = (ALL_fu3_completed/Tot_agreed)*100) %>% mutate(All_both3_percent = (ALL_both3_completed/Tot_agreed)*100) %>%
  mutate(All_fu4_percent = (ALL_fu4_completed/Tot_agreed)*100) %>% mutate(All_both4_percent = (ALL_both4_completed/Tot_agreed)*100) %>%
  mutate(All_base_percent=round(All_base_percent, digits=2)) %>% 
  mutate(All_fu_percent=round(All_fu_percent, digits=2)) %>% mutate(All_both_percent=round(All_both_percent, digits=2)) %>% 
  mutate(All_fu2_percent=round(All_fu2_percent, digits=2)) %>% mutate(All_both2_percent=round(All_both2_percent, digits=2)) %>%
  mutate(All_fu3_percent=round(All_fu3_percent, digits=2)) %>% mutate(All_both3_percent=round(All_both3_percent, digits=2)) %>%
  mutate(All_fu4_percent=round(All_fu4_percent, digits=2)) %>% mutate(All_both4_percent=round(All_both4_percent, digits=2)) %>%
  select(Respondant, Tot_agreed, ALL_base_completed, All_base_percent, # Tot_contacted, Agreed_percent, 
    ALL_fu_completed, All_fu_percent, ALL_fu2_completed, All_fu2_percent, ALL_fu3_completed, All_fu3_percent, ALL_fu4_completed, All_fu4_percent, 
    ALL_both_completed, All_both_percent, ALL_both2_completed, All_both2_percent, ALL_both3_completed, All_both3_percent, ALL_both4_completed, All_both4_percent)

crisis_table <- tibble(Respondant=c("Parent", "Child"), 
                       # Tot_contacted=c(parent_contacted, child_contacted),
                       Tot_agreed=c(parent_agreed, child_agreed), 
                       CRISIS_base_completed=c(parent_completed_crisis_base_num, child_completed_crisis_base_num),
                       CRISIS_fu_completed=c(parent_completed_crisis_fu_num1, child_completed_crisis_fu_num1), 
                       CRISIS_fu2_completed=c(parent_completed_crisis_fu_num2, child_completed_crisis_fu_num2), 
                       CRISIS_fu3_completed=c(parent_completed_crisis_fu_num3, child_completed_crisis_fu_num3), 
                       CRISIS_fu4_completed=c(parent_completed_crisis_fu_num4, child_completed_crisis_fu_num4), 
                       CRISIS_both_completed=c(parent_completed_crisis_both_num1, child_completed_crisis_both_num1), 
                       CRISIS_both2_completed=c(parent_completed_crisis_both_num2, child_completed_crisis_both_num2),
                       CRISIS_both3_completed=c(parent_completed_crisis_both_num3, child_completed_crisis_both_num3),
                       CRISIS_both4_completed=c(parent_completed_crisis_both_num4, child_completed_crisis_both_num4)) %>% 
  # mutate(Agreed_percent = (Tot_agreed/Tot_contacted)*100) %>% 
  mutate(CRISIS_base_percent = (CRISIS_base_completed/Tot_agreed)*100) %>%
  mutate(CRISIS_fu_percent = (CRISIS_fu_completed/Tot_agreed)*100) %>% mutate(CRISIS_both_percent = (CRISIS_both_completed/Tot_agreed)*100) %>%
  mutate(CRISIS_fu2_percent = (CRISIS_fu2_completed/Tot_agreed)*100) %>% mutate(CRISIS_both2_percent = (CRISIS_both2_completed/Tot_agreed)*100) %>%
  mutate(CRISIS_fu3_percent = (CRISIS_fu3_completed/Tot_agreed)*100) %>% mutate(CRISIS_both3_percent = (CRISIS_both3_completed/Tot_agreed)*100) %>%
  mutate(CRISIS_fu4_percent = (CRISIS_fu4_completed/Tot_agreed)*100) %>% mutate(CRISIS_both4_percent = (CRISIS_both4_completed/Tot_agreed)*100) %>%
  # mutate(Agreed_percent=round(Agreed_percent, digits=2)) %>% 
  mutate(CRISIS_base_percent=round(CRISIS_base_percent, digits=2)) %>% 
  mutate(CRISIS_fu_percent=round(CRISIS_fu_percent, digits=2)) %>% mutate(CRISIS_both_percent=round(CRISIS_both_percent, digits=2)) %>% 
  mutate(CRISIS_fu2_percent=round(CRISIS_fu2_percent, digits=2)) %>% mutate(CRISIS_both2_percent=round(CRISIS_both2_percent, digits=2)) %>% 
  mutate(CRISIS_fu3_percent=round(CRISIS_fu3_percent, digits=2)) %>% mutate(CRISIS_both3_percent=round(CRISIS_both3_percent, digits=2)) %>% 
  mutate(CRISIS_fu4_percent=round(CRISIS_fu4_percent, digits=2)) %>% mutate(CRISIS_both4_percent=round(CRISIS_both4_percent, digits=2)) %>% 
  select(Respondant, Tot_agreed, CRISIS_base_completed, CRISIS_base_percent, CRISIS_fu_completed, CRISIS_fu_percent, # Tot_contacted, Agreed_percent,
         CRISIS_fu2_completed, CRISIS_fu2_percent, CRISIS_fu3_completed, CRISIS_fu3_percent, CRISIS_fu4_completed, CRISIS_fu4_percent, 
    CRISIS_both_completed, CRISIS_both_percent, CRISIS_both2_completed, CRISIS_both2_percent, CRISIS_both3_completed, CRISIS_both3_percent,
    CRISIS_both4_completed, CRISIS_both4_percent)

```

<!-- *** -->

<!-- ##### Agreed to participate: -->
<!-- ### -->

```{r echo=FALSE, warning=FALSE, message=FALSE}

# all_table %>% select(-ALL_base_completed:-All_both3_percent) %>% 
#   kable(., col.names = c("Respondant", "Total Contacted", "Total Agreed to Participate", "%")) %>% 
#   kable_styling(position = "left", bootstrap_options = c("striped", "hover", "condensed"))

```

***

##### Completed all measures (MFQ, SCARED (short) & CRISIS): 
### 

Each timepoint separately:

```{r echo=FALSE, warning=FALSE, message=FALSE}

all_table %>% # select(-Tot_contacted:-Agreed_percent) %>% 
  select(Respondant:All_fu4_percent) %>% 
  kable(., col.names = c("Respondant", "Total agreed", "Completed baseline", "%", "Completed follow up 1", "%", "Completed follow up 2", "%", 
    "Completed follow up 3", "%", "Completed follow up 4", "%")) %>% 
  kable_styling(position = "left", bootstrap_options = c("striped", "hover", "condensed"))

```

Completing all timepoints:

```{r echo=FALSE, warning=FALSE, message=FALSE}

all_table %>% # select(-Tot_contacted:-Agreed_percent) %>% 
  select(Respondant, Tot_agreed, ALL_both_completed:All_both4_percent) %>% 
  kable(., col.names = c("Respondant", "Total agreed", "Completed baseline & follow up 1", "%", "Completed baseline & follow ups 1 & 2", "%", 
    "Completed baseline & follow ups 1-3", "%", "Completed baseline & follow ups 1-4", "%")) %>% 
  kable_styling(position = "left", bootstrap_options = c("striped", "hover", "condensed"))

```

***

##### Completed CRISIS: 
###

Each timepoint separately:

```{r echo=FALSE, warning=FALSE, message=FALSE}

crisis_table %>% # select(-Tot_contacted:-Agreed_percent) %>% 
  select(Respondant:CRISIS_fu4_percent) %>% 
  kable(., col.names = c("Respondant", "Total agreed", "Completed CRISIS: baseline", "%", "Completed CRISIS: follow up 1", "%", "Completed CRISIS: follow up 2", "%",
    "Completed CRISIS: follow up 3", "%", "Completed CRISIS: follow up 4", "%")) %>% 
  kable_styling(position = "left", bootstrap_options = c("striped", "hover", "condensed"))

```

Completing all timepoints:

```{r echo=FALSE, warning=FALSE, message=FALSE}

crisis_table %>% # select(-Tot_contacted:-Agreed_percent) %>% 
  select(Respondant, Tot_agreed, CRISIS_both_completed:CRISIS_both4_percent) %>% 
  kable(., col.names = c("Respondant", "Total agreed", "Completed CRISIS: baseline & follow up 1", "%", "Completed CRISIS: baseline & follow ups 1 & 2", "%",
    "Completed CRISIS: baseline & follow ups 1-3", "%", "Completed CRISIS: baseline & follow ups 1-4", "%")) %>% 
  kable_styling(position = "left", bootstrap_options = c("striped", "hover", "condensed"))

```

```{r echo=FALSE, warning=FALSE, message=FALSE, results="hide" }

measures_completed <- measures_completed %>% filter(!is.na(s_mfq_tot) | !is.na(s_scaredshort_tot) | !is.na(s_crisis_base_tot) | !is.na(s_crisis_fu_tot) |
                        !is.na(p_mfq_tot) | !is.na(p_scaredshort_tot) | !is.na(p_crisis_base_tot) | !is.na(p_crisis_fu_tot))

smfq_tminus2_long <- Psychometrics_treatment %>% 
  select(Initials, SDAN, PLUSID, Participant_Type2, IRTA_tracker, SEX, Age_at_visit,
         c_ksadsdx_primary_dx, c_ksadsdx_dx_detailed, s_mfq1w_tot, s_mfq_tot, s_mfq1w_date, s_mfq_date) %>% rename(Age = "Age_at_visit") %>% 
  filter(!is.na(s_mfq1w_tot) | !is.na(s_mfq_tot)) %>% mutate(Age = round(Age, digits = 0))
smfq_tminus2_long$s_mfq_tot <- coalesce(smfq_tminus2_long$s_mfq_tot, smfq_tminus2_long$s_mfq1w_tot) %>% round(., digits = 0)
smfq_tminus2_long$s_mfq_date <- coalesce(smfq_tminus2_long$s_mfq_date, smfq_tminus2_long$s_mfq1w_date) %>% round(., digits = 0)
smfq_tminus2_long <- smfq_tminus2_long %>% filter(s_mfq_date <= "2020-03-11") %>% group_by(Initials) %>% 
  arrange(s_mfq_date) %>% slice(1,n()) %>% distinct(., .keep_all = TRUE) %>% select(-s_mfq1w_date, -s_mfq1w_tot) %>% 
  mutate(id = row_number()) %>% ungroup() %>% filter(Initials %in% measures_completed$Initials)

sscared_tminus2_long <- Psychometrics_treatment %>% 
  select(Initials, SDAN, PLUSID, Participant_Type2, IRTA_tracker, SEX, Age_at_visit,
         c_ksadsdx_primary_dx, c_ksadsdx_dx_detailed, s_scared_tot, s_scared_date) %>% rename(Age = "Age_at_visit") %>% 
  filter(!is.na(s_scared_tot)) %>% mutate(s_scared_tot = round(s_scared_tot, digits = 0)) %>% mutate(Age = round(Age, digits = 0))
sscared_tminus2_long <- sscared_tminus2_long %>% filter(s_scared_date <= "2020-03-11") %>% group_by(Initials) %>% 
  arrange(s_scared_date) %>% slice(1,n()) %>% distinct(., .keep_all = TRUE) %>% mutate(id = row_number()) %>% 
  ungroup() %>% filter(Initials %in% measures_completed$Initials)

pmfq_tminus2_long <- Psychometrics_treatment %>% 
  select(Initials, SDAN, PLUSID, Participant_Type2, IRTA_tracker, SEX, Age_at_visit,
         c_ksadsdx_primary_dx, c_ksadsdx_dx_detailed, p_mfq1w_tot, p_mfq_tot, p_mfq1w_date, p_mfq_date) %>% rename(Age = "Age_at_visit") %>% 
  filter(!is.na(p_mfq1w_tot) | !is.na(p_mfq_tot)) %>% mutate(Age = round(Age, digits = 0))
pmfq_tminus2_long$p_mfq_tot <- coalesce(pmfq_tminus2_long$p_mfq_tot, pmfq_tminus2_long$p_mfq1w_tot) %>% round(., digits = 0)
pmfq_tminus2_long$p_mfq_date <- coalesce(pmfq_tminus2_long$p_mfq_date, pmfq_tminus2_long$p_mfq1w_date) %>% round(., digits = 0)
pmfq_tminus2_long <- pmfq_tminus2_long %>% filter(p_mfq_date <= "2020-03-11") %>% group_by(Initials) %>% 
  arrange(p_mfq_date) %>% slice(1,n()) %>% distinct(., .keep_all = TRUE) %>% mutate(id = row_number()) %>% ungroup() %>% 
  select(-p_mfq1w_date, -p_mfq1w_tot) %>% filter(Initials %in% measures_completed$Initials)

pscared_tminus2_long <- Psychometrics_treatment %>% 
  select(Initials, SDAN, PLUSID, Participant_Type2, IRTA_tracker, SEX, Age_at_visit,
         c_ksadsdx_primary_dx, c_ksadsdx_dx_detailed, p_scared_tot, p_scared_date) %>% 
  filter(!is.na(p_scared_tot)) %>% mutate(p_scared_tot = round(p_scared_tot, digits = 0)) %>% rename(Age = "Age_at_visit") %>% 
  mutate(Age = round(Age, digits = 0))
pscared_tminus2_long <- pscared_tminus2_long %>% filter(p_scared_date <= "2020-03-11") %>% group_by(Initials) %>% 
  arrange(p_scared_date) %>% slice(1,n()) %>% distinct(., .keep_all = TRUE) %>% mutate(id = row_number()) %>% 
  ungroup() %>% filter(Initials %in% measures_completed$Initials)

measures_combined_long <- merge.default(smfq_tminus2_long, sscared_tminus2_long, all=TRUE) %>% 
  merge.default(., pmfq_tminus2_long, all=TRUE) %>% merge.default(., pscared_tminus2_long, all=TRUE) %>%
  distinct(., .keep_all = TRUE)

crisis_final <- merge.default(measures_completed, measures_combined_long, all=TRUE) %>% rename(Sex = "SEX")
crisis_final$row_label <- recode(crisis_final$id, `1`="baseline", `2`="pre-covid", 
                          `3`="crisis_t1", `4`="crisis_t2", `5`="crisis_t3", `6`="crisis_t4", `7`="crisis_t5", `8`="crisis_t6", `9`="crisis_t7")
crisis_final <- crisis_final %>% select(Initials, SDAN, PLUSID, IRTA_tracker, Sex, Age, c_ksadsdx_primary_dx, c_ksadsdx_dx_detailed, 
                                        id, row_label, matches("_mfq"), matches("scared"), matches("s_crisis_"), matches("p_crisis"))

```

```{r echo=FALSE, warning=FALSE, message=FALSE, results="hide" }

############ CRISIS
crisis_subset1 <- crisis_final %>% select(Initials, c_ksadsdx_primary_dx, id, row_label, s_crisis_3m_tot, s_crisis_3m_date) %>% 
  filter(!is.na(s_crisis_3m_tot)) %>% arrange(Initials, id) %>% group_by(Initials) %>% slice(1) %>% ungroup() %>% 
  rename(s_crisis_tot="s_crisis_3m_tot") %>% rename(s_crisis_date="s_crisis_3m_date") %>% mutate(row_label="pre-covid") %>% mutate(id="1")
crisis_subset2 <- crisis_final %>% select(Initials, c_ksadsdx_primary_dx, id, row_label, s_crisis_base_tot, s_crisis_base_date) %>% 
  filter(!is.na(s_crisis_base_tot)) %>% arrange(Initials, id) %>% group_by(Initials) %>% slice(1) %>% ungroup() %>% 
  rename(s_crisis_tot="s_crisis_base_tot") %>% rename(s_crisis_date="s_crisis_base_date") %>% mutate(row_label="baseline") %>% mutate(id="2")
crisis_subset3 <- crisis_final %>% select(Initials, c_ksadsdx_primary_dx, id, row_label, s_crisis_fu_tot, s_crisis_fu_date) %>% 
  filter(!is.na(s_crisis_fu_tot)) %>% arrange(Initials, id) %>% group_by(Initials) %>% slice(1) %>% ungroup() %>% 
  rename(s_crisis_tot="s_crisis_fu_tot") %>% rename(s_crisis_date="s_crisis_fu_date") %>% mutate(row_label="followup1") %>% mutate(id="3")
crisis_subset4 <- crisis_final %>% select(Initials, c_ksadsdx_primary_dx, id, row_label, s_crisis_fu_tot, s_crisis_fu_date) %>% 
  filter(!is.na(s_crisis_fu_tot)) %>% arrange(Initials, id) %>% group_by(Initials) %>% filter(n()>1) %>% slice(2) %>% ungroup() %>% 
  rename(s_crisis_tot="s_crisis_fu_tot") %>% rename(s_crisis_date="s_crisis_fu_date") %>% mutate(row_label="followup2") %>% mutate(id="4")
crisis_subset5 <- crisis_final %>% select(Initials, c_ksadsdx_primary_dx, id, row_label, s_crisis_fu_tot, s_crisis_fu_date) %>% 
  filter(!is.na(s_crisis_fu_tot)) %>% arrange(Initials, id) %>% group_by(Initials) %>% filter(n()>2) %>% slice(3) %>% ungroup() %>% 
  rename(s_crisis_tot="s_crisis_fu_tot") %>% rename(s_crisis_date="s_crisis_fu_date") %>% mutate(row_label="followup3") %>% mutate(id="5")
crisis_subset6 <- crisis_final %>% select(Initials, c_ksadsdx_primary_dx, id, row_label, s_crisis_fu_tot, s_crisis_fu_date) %>% 
  filter(!is.na(s_crisis_fu_tot)) %>% arrange(Initials, id) %>% group_by(Initials) %>% filter(n()>3) %>% slice(4) %>% ungroup() %>% 
  rename(s_crisis_tot="s_crisis_fu_tot") %>% rename(s_crisis_date="s_crisis_fu_date") %>% mutate(row_label="followup4") %>% mutate(id="6")
crisis_subset7 <- crisis_final %>% select(Initials, c_ksadsdx_primary_dx, id, row_label, s_crisis_fu_tot, s_crisis_fu_date) %>% 
  filter(!is.na(s_crisis_fu_tot)) %>% arrange(Initials, id) %>% group_by(Initials) %>% filter(n()>4) %>% slice(5) %>% ungroup() %>% 
  rename(s_crisis_tot="s_crisis_fu_tot") %>% rename(s_crisis_date="s_crisis_fu_date") %>% mutate(row_label="followup5") %>% mutate(id="7")
crisis_subset8 <- crisis_final %>% select(Initials, c_ksadsdx_primary_dx, id, row_label, s_crisis_fu_tot, s_crisis_fu_date) %>% 
  filter(!is.na(s_crisis_fu_tot)) %>% arrange(Initials, id) %>% group_by(Initials) %>% filter(n()>5) %>% slice(6) %>% ungroup() %>% 
  rename(s_crisis_tot="s_crisis_fu_tot") %>% rename(s_crisis_date="s_crisis_fu_date") %>% mutate(row_label="followup6") %>% mutate(id="8")
crisis_subset9 <- crisis_final %>% select(Initials, c_ksadsdx_primary_dx, id, row_label, s_crisis_fu_tot, s_crisis_fu_date) %>% 
  filter(!is.na(s_crisis_fu_tot)) %>% arrange(Initials, id) %>% group_by(Initials) %>% filter(n()>6) %>% slice(7) %>% ungroup() %>% 
  rename(s_crisis_tot="s_crisis_fu_tot") %>% rename(s_crisis_date="s_crisis_fu_date") %>% mutate(row_label="followup7") %>% mutate(id="9")

crisis_subset <- merge.default(crisis_subset1, crisis_subset2, all = TRUE) %>% merge.default(., crisis_subset3, all = TRUE) %>% 
  merge.default(., crisis_subset4, all = TRUE) %>% merge.default(., crisis_subset5, all = TRUE) %>% merge.default(., crisis_subset6, all = TRUE) %>% 
  merge.default(., crisis_subset7, all = TRUE) %>% merge.default(., crisis_subset8, all = TRUE) %>% merge.default(., crisis_subset9, all = TRUE)
crisis_subset <- crisis_subset %>% filter(!is.na(c_ksadsdx_primary_dx)) 

crisis_group_means <- crisis_subset %>% group_by(c_ksadsdx_primary_dx, id, row_label) %>%
  summarise(s_crisis_mean=mean(s_crisis_tot), s_crisis_sd=sd(s_crisis_tot), s_crisis_N=n()) %>%
  mutate(s_crisis_mean=round(s_crisis_mean, digit=2), s_crisis_sd=round(s_crisis_sd, digit=2)) %>% ungroup()

############ MFQ
mfq_subset1 <- crisis_final %>% select(Initials, c_ksadsdx_primary_dx, id, row_label, s_mfq_tot, s_mfq_date) %>% filter(!is.na(s_mfq_tot)) %>% 
  arrange(Initials, desc(s_mfq_date)) %>% filter(!str_detect(row_label, "crisis")) %>% group_by(Initials) %>% slice(1) %>% ungroup() %>% 
  mutate(row_label="pre-covid") %>% mutate(id=1)
mfq_subset2 <- crisis_final %>% select(Initials, c_ksadsdx_primary_dx, id, row_label, s_mfq_tot, s_mfq_date) %>% filter(!is.na(s_mfq_tot)) %>% 
  arrange(Initials, s_mfq_date) %>% filter(str_detect(row_label, "crisis")) %>% group_by(Initials) %>% mutate(id = (row_number()+1)) %>% ungroup()
mfq_subset <- merge.default(mfq_subset1, mfq_subset2, all=TRUE)
mfq_subset$row_label <- recode(mfq_subset$id, `1`="pre-covid", `2`="baseline", `3`="followup1", `4`="followup2", `5`="followup3", `6`="followup4", 
  `7`="followup5", `8`="followup6", `9`="followup7")

mfq_group_means <- mfq_subset %>% group_by(c_ksadsdx_primary_dx, id, row_label) %>% 
  summarise(s_mfq_mean=mean(s_mfq_tot), s_mfq_sd=sd(s_mfq_tot), s_mfq_N=n()) %>%
  mutate(s_mfq_mean=round(s_mfq_mean, digit=2), s_mfq_sd=round(s_mfq_sd, digit=2)) %>% ungroup()

############ SCARED
scared_subset1 <- crisis_final %>% select(Initials, c_ksadsdx_primary_dx, id, row_label, s_scared_tot, s_scared_date) %>% filter(!is.na(s_scared_tot)) %>% 
  arrange(Initials, desc(s_scared_date)) %>% filter(!str_detect(row_label, "crisis")) %>% group_by(Initials) %>% slice(1) %>% ungroup() %>% 
  mutate(row_label="pre-covid") %>% mutate(id=1)
scaredshort_subset2 <- crisis_final %>% select(Initials, c_ksadsdx_primary_dx, id, row_label, s_scaredshort_tot, s_scaredshort_date) %>%
  filter(!is.na(s_scaredshort_tot)) %>% arrange(Initials, s_scaredshort_date) %>% mutate(s_scaredshort_tot=((s_scaredshort_tot/9)*41)) %>% 
  mutate(s_scaredshort_tot=round(s_scaredshort_tot, digits = 0)) %>% rename(s_scared_tot="s_scaredshort_tot") %>% 
  rename(s_scared_date="s_scaredshort_date") %>% group_by(Initials) %>% mutate(id = (row_number()+1)) %>% ungroup()
scared_subset <- merge.default(scared_subset1, scaredshort_subset2, all=TRUE)
scared_subset$row_label <- recode(scared_subset$id, `1`="pre-covid", `2`="baseline", `3`="followup1", `4`="followup2", `5`="followup3", `6`="followup4",
  `7`="followup5", `8`="followup6", `9`="followup7")

scared_group_means <- scared_subset %>% group_by(c_ksadsdx_primary_dx, id, row_label) %>% 
  summarise(s_scared_mean=mean(s_scared_tot), s_scared_sd=sd(s_scared_tot), s_scared_N=n()) %>%
  mutate(s_scared_mean=round(s_scared_mean, digit=2), s_scared_sd=round(s_scared_sd, digit=2)) %>% ungroup()

```

***

##### CRISIS descriptives: 
###

```{r echo=FALSE, warning=FALSE, message=FALSE}

crisis_group_means$s_crisis_combined <- paste(crisis_group_means$s_crisis_mean, " (", crisis_group_means$s_crisis_sd, ")", sep="")
crisis_group_means_t <- crisis_group_means %>% 
  pivot_wider(., id_cols = c("id", "row_label"), names_from = "c_ksadsdx_primary_dx", values_from = c("s_crisis_combined", "s_crisis_N")) %>% 
  select(id, row_label, s_crisis_combined_Healthy, s_crisis_N_Healthy, s_crisis_combined_MDD, s_crisis_N_MDD, `s_crisis_combined_Sub-MDD`, `s_crisis_N_Sub-MDD`)

crisis_group_means_t %>% kable(., col.names = c("Time point", "Type", "Healthy: M (SD)", "N", "MDD: M (SD)", "N", "Sub-MDD: M (SD)", "N")) %>% 
  kable_styling(position = "left", bootstrap_options = c("striped", "hover", "condensed"))

```

***

##### CRISIS graph: individual lines + group mean by Dx
###

```{r echo=FALSE, warning=FALSE, message=FALSE}

ggplot() +
  geom_line(data = crisis_group_means, aes(x=row_label, y=s_crisis_mean, group=c_ksadsdx_primary_dx, color=c_ksadsdx_primary_dx), size=2) + 
  geom_line(data = crisis_subset, aes(x=row_label, y=s_crisis_tot, group=Initials, color=c_ksadsdx_primary_dx), alpha=0.25) +
  labs(x="\nTime point", y="CRISIS total\n") +
  # labs(title="Depression symptoms\n", x="\nTime point", y="CRISIS total\n") +
  scale_color_manual(values=c("#CC0000", "#006600", "#0000CC")) + 
  scale_x_discrete(expand = c(0,0), limit = c("pre-covid", "baseline", "followup1", "followup2", "followup3", "followup4")) + 
  theme_minimal() +
  guides(color=guide_legend("Diagnosis:"))

```

<!-- CRISIS graph: only Dx group mean lines -->

```{r echo=FALSE, warning=FALSE, message=FALSE}

# ggplot(crisis_subset, aes(x=id, y=s_crisis_tot, color=c_ksadsdx_primary_dx), na.rm = TRUE) +
#   geom_point(aes(group=Initials), size=1) +
#   geom_line(data = crisis_group_means, size=2) + 
#   labs(title="Responses to CRISIS questionnaire\n", x="\nTime point", y="CRISIS total\n") +
#   scale_color_manual(values=c("#CC0000", "#006600", "#0000CC")) + 
#   theme_minimal() +
#   guides(color=guide_legend("Diagnosis:"))

```

***

##### MFQ group means: 
###

```{r echo=FALSE, warning=FALSE, message=FALSE}

mfq_group_means$s_mfq_combined <- paste(mfq_group_means$s_mfq_mean, " (", mfq_group_means$s_mfq_sd, ")", sep="")
mfq_group_means_t <- mfq_group_means %>% 
  pivot_wider(., id_cols = c("id", "row_label"), names_from = "c_ksadsdx_primary_dx", values_from = c("s_mfq_combined", "s_mfq_N")) %>% 
  select(id, row_label, s_mfq_combined_Healthy, s_mfq_N_Healthy, s_mfq_combined_MDD, s_mfq_N_MDD, `s_mfq_combined_Sub-MDD`, `s_mfq_N_Sub-MDD`)

mfq_group_means_t %>% kable(., col.names = c("Time point", "Type", "Healthy: M (SD)", "N", "MDD: M (SD)", "N", "Sub-MDD: M (SD)", "N")) %>% 
  kable_styling(position = "left", bootstrap_options = c("striped", "hover", "condensed"))

```

***

##### MFQ graph: individual lines + group mean by Dx
###

```{r echo=FALSE, warning=FALSE, message=FALSE}

ggplot() +
  geom_line(data=mfq_group_means, aes(x=row_label, y=s_mfq_mean, group=c_ksadsdx_primary_dx, color=c_ksadsdx_primary_dx), size=2) + 
  geom_line(data = mfq_subset, aes(x=row_label, y=s_mfq_tot, group=Initials, color=c_ksadsdx_primary_dx), alpha=0.25) +
  labs(x="\nTime point", y="MFQ total\n") +
  # labs(title="Depression symptoms\n", x="\nTime point", y="MFQ total\n") +
  scale_color_manual(values=c("#CC0000", "#006600", "#0000CC")) + 
  scale_x_discrete(expand = c(0,0), limit = c("pre-covid", "baseline", "followup1", "followup2", "followup3", "followup4")) + 
  theme_minimal() +
  guides(color=guide_legend("Diagnosis:"))

```

##### ALTERNATIVE MFQ GRAPH: all timepoints in our study
###

```{r echo=FALSE, warning=FALSE, message=FALSE, results="hide" }

measures_all <- Psychometrics_treatment %>% filter(Clinical_Visit_Date >= "2016-10-01") %>% 
  select(Initials, SDAN, PLUSID, Participant_Type2, IRTA_tracker, Clinical_Visit_Date, Clinical_Visit_Type, SEX, Age_at_visit,
         c_ksadsdx_primary_dx, c_ksadsdx_dx_detailed, 
         s_mfq1w_tot, s_mfq1w_date, s_mfq_tot, s_mfq_date, s_scared_tot, s_scared_date, s_scaredshort_tot, s_scaredshort_date, 
         s_crisis_3m_tot, s_crisis_3m_date, s_crisis_base_tot, s_crisis_base_date, s_crisis_fu_tot, s_crisis_fu_date, 
         p_mfq1w_tot, p_mfq1w_date, p_mfq_tot, p_mfq_date, p_scared_tot, p_scared_date, p_scaredshort_tot, p_scaredshort_date, 
         p_crisis_3m_tot, p_crisis_3m_date, p_crisis_base_tot, p_crisis_base_date, p_crisis_fu_tot, p_crisis_fu_date) %>% 
  rename(Age = "Age_at_visit") %>% mutate(Age = round(Age, digits = 0))
measures_all$s_mfq_tot <- coalesce(measures_all$s_mfq_tot, measures_all$s_mfq1w_tot) %>% round(., digits = 0)
measures_all$p_mfq_tot <- coalesce(measures_all$p_mfq_tot, measures_all$p_mfq1w_tot) %>% round(., digits = 0)
measures_all$s_mfq_date <- coalesce(measures_all$s_mfq_date, measures_all$s_mfq1w_date) %>% round(., digits = 0)
measures_all$p_mfq_date <- coalesce(measures_all$p_mfq_date, measures_all$p_mfq1w_date) %>% round(., digits = 0)
measures_all <- measures_all %>% select(-s_mfq1w_tot, -p_mfq1w_tot, -s_mfq1w_date, -p_mfq1w_date) 

split1 <- colsplit(measures_all$Clinical_Visit_Date, "-", names = c("year", "month", "day"))
measures_all <- cbind(measures_all, split1)
measures_all <- measures_all %>% mutate(day2 = ifelse(day < 7, 1, ifelse((day >= 7 & day <14), 7, ifelse((day >=14 & day < 21), 14, ifelse(day >=21, 21, 0)))))
measures_all$Clinical_Visit_Date3c <- as.Date(paste(measures_all$year, measures_all$month, measures_all$day2, sep="-"))
measures_all <- measures_all %>% select(Initials:IRTA_tracker, matches("Clinical_Visit_Date"), year, month, day, day2, Clinical_Visit_Type:p_crisis_fu_date)

s_mfq_subset <- measures_all %>% filter(c_ksadsdx_primary_dx=="MDD" | c_ksadsdx_primary_dx=="Healthy") %>% filter(!is.na(s_mfq_tot))
mfq_group_means <- s_mfq_subset %>% group_by(c_ksadsdx_primary_dx, Clinical_Visit_Date3c) %>%
  summarise(s_mfq_mean=mean(s_mfq_tot), s_mfq_sd=sd(s_mfq_tot), s_mfq_N=n()) %>%
  mutate(s_mfq_mean=round(s_mfq_mean, digit=2), s_mfq_sd=round(s_mfq_sd, digit=2)) %>% ungroup()

s_mfq_subset_recent <- measures_all %>% filter(c_ksadsdx_primary_dx=="MDD" | c_ksadsdx_primary_dx=="Healthy") %>% filter(!is.na(s_mfq_tot)) %>%
  filter(Clinical_Visit_Date3c >= "2020-01-01") %>% select(Initials, Clinical_Visit_Date, Clinical_Visit_Date3c, c_ksadsdx_primary_dx, s_mfq_tot)
mfq_group_means_recent <- s_mfq_subset_recent %>% group_by(c_ksadsdx_primary_dx, Clinical_Visit_Date3c) %>%
  summarise(s_mfq_mean=mean(s_mfq_tot), s_mfq_sd=sd(s_mfq_tot), s_mfq_N=n()) %>%
  mutate(s_mfq_mean=round(s_mfq_mean, digit=2), s_mfq_sd=round(s_mfq_sd, digit=2)) %>% ungroup()

s_mfq_subset_recent2 <- measures_all %>% filter(c_ksadsdx_primary_dx=="MDD" | c_ksadsdx_primary_dx=="Healthy") %>% filter(!is.na(s_mfq_tot)) %>%
  filter(Clinical_Visit_Date3c >= "2020-03-01") %>% select(Initials, Clinical_Visit_Date, Clinical_Visit_Date3c, c_ksadsdx_primary_dx, s_mfq_tot)
mfq_group_means_recent2 <- s_mfq_subset_recent2 %>% group_by(c_ksadsdx_primary_dx, Clinical_Visit_Date3c) %>%
  summarise(s_mfq_mean=mean(s_mfq_tot), s_mfq_sd=sd(s_mfq_tot), s_mfq_N=n()) %>%
  mutate(s_mfq_mean=round(s_mfq_mean, digit=2), s_mfq_sd=round(s_mfq_sd, digit=2)) %>% ungroup()

```

```{r echo=FALSE, warning=FALSE, message=FALSE}

ggplot() +
  geom_line(data= mfq_group_means, aes(x=Clinical_Visit_Date3c, y=s_mfq_mean, group=c_ksadsdx_primary_dx, color=c_ksadsdx_primary_dx), size=0.5) +
  geom_line(data = s_mfq_subset, aes(x=Clinical_Visit_Date3c, y=s_mfq_tot, group=Initials, color=c_ksadsdx_primary_dx), alpha=0.25) +
  labs(x="\nTime point", y="MFQ total\n") +
  scale_color_manual(values=c("#CC0000", "#006600")) + 
  scale_x_date(date_break = "4 months", date_labels = "%m/%y") +
  geom_vline(xintercept=as.Date("2020-03-01"), size=1, colour="#000000") +
  geom_text(aes(x=as.Date("2020-03-01"), label="March 2020\n", y=30), colour="#000000", angle=90, text=element_text(size=10)) +
  ylim(0,40) +
  theme_minimal() +
  guides(color=guide_legend("Diagnosis:"))

```

Limiting to measures collected from Jan 2020 - present: 

```{r echo=FALSE, warning=FALSE, message=FALSE}

ggplot() +
  geom_line(data = mfq_group_means_recent, aes(x=Clinical_Visit_Date3c, y=s_mfq_mean, group=c_ksadsdx_primary_dx, color=c_ksadsdx_primary_dx), size=0.5, na.rm=TRUE) +
  geom_line(data = s_mfq_subset_recent, aes(x=Clinical_Visit_Date3c, y=s_mfq_tot, group=Initials, color=c_ksadsdx_primary_dx), alpha=0.25, na.rm=TRUE) +
  labs(x="\nTime point", y="MFQ total\n") +
  scale_color_manual(values=c("#CC0000", "#006600")) +
  scale_x_date(date_break = "1 month", date_labels = "%m/%y") +
  geom_vline(xintercept=as.Date("2020-03-01"), size=1, colour="#000000") +
  geom_text(aes(x=as.Date("2020-03-01"), label="March 2020\n", y=30), colour="#000000", angle=90, text=element_text(size=10)) +
  theme_minimal() + ylim(0,40) +
  guides(color=guide_legend("Diagnosis:"))

```

Limiting to measures collected from March 2020 - present: 

```{r echo=FALSE, warning=FALSE, message=FALSE}

ggplot() +
  geom_line(data = mfq_group_means_recent2, aes(x=Clinical_Visit_Date3c, y=s_mfq_mean, group=c_ksadsdx_primary_dx, color=c_ksadsdx_primary_dx), size=0.5, na.rm=TRUE) +
  geom_line(data = s_mfq_subset_recent2, aes(x=Clinical_Visit_Date3c, y=s_mfq_tot, group=Initials, color=c_ksadsdx_primary_dx), alpha=0.25, na.rm=TRUE) +
  labs(x="\nTime point", y="MFQ total\n") +
  scale_color_manual(values=c("#CC0000", "#006600")) +
  scale_x_date(date_break = "1 month", date_labels = "%m/%y") +
  # geom_vline(xintercept=as.Date("2020-03-01"), size=1, colour="#000000") +
  # geom_text(aes(x=as.Date("2020-03-01"), label="March 2020\n", y=25), colour="#000000", angle=90, text=element_text(size=10)) +
  theme_minimal() + ylim(0,40) +
  guides(color=guide_legend("Diagnosis:"))

```

***

##### SCARED group means: 
###

```{r echo=FALSE, warning=FALSE, message=FALSE}

scared_group_means$s_scared_combined <- paste(scared_group_means$s_scared_mean, " (", scared_group_means$s_scared_sd, ")", sep="")
scared_group_means_t <- scared_group_means %>% 
  pivot_wider(., id_cols = c("id", "row_label"), names_from = "c_ksadsdx_primary_dx", values_from = c("s_scared_combined", "s_scared_N")) %>% 
  select(id, row_label, s_scared_combined_Healthy, s_scared_N_Healthy, s_scared_combined_MDD, 
         s_scared_N_MDD, `s_scared_combined_Sub-MDD`, `s_scared_N_Sub-MDD`)

scared_group_means_t %>% kable(., col.names = c("Time point", "Type", "Healthy: M (SD)", "N", "MDD: M (SD)", "N", "Sub-MDD: M (SD)", "N")) %>% 
  kable_styling(position = "left", bootstrap_options = c("striped", "hover", "condensed"))

```

***

##### SCARED graph: individual lines + group mean by Dx
###

```{r echo=FALSE, warning=FALSE, message=FALSE}

ggplot() +
  geom_line(data=scared_group_means, aes(x=row_label, y=s_scared_mean, group=c_ksadsdx_primary_dx, color=c_ksadsdx_primary_dx), size=2) + 
  geom_line(data = scared_subset, aes(x=row_label, y=s_scared_tot, group=Initials, color=c_ksadsdx_primary_dx), alpha=0.25) +
  labs(x="\nTime point", y="SCARED total\n") +
  # labs(title="Depression symptoms\n", x="\nTime point", y="SCARED total\n") +
  scale_color_manual(values=c("#CC0000", "#006600", "#0000CC")) + 
  scale_x_discrete(expand = c(0,0), limit = c("pre-covid", "baseline", "followup1", "followup2", "followup3", "followup4")) + 
  theme_minimal() +
  guides(color=guide_legend("Diagnosis:"))

```

***

\pagebreak

```{r echo=FALSE, warning=FALSE, message=FALSE, results="hide" }

rm(list=ls(pattern="child_completed_"))
rm(list=ls(pattern="parent_completed_"))
rm(parent_agreed, child_agreed, all_table, crisis_table, measures_combined_long, 
  pscared_tminus2_long, pmfq_tminus2_long, smfq_tminus2_long, scared_group_means_t, scared_group_means, scared_subset, 
  scaredshort_subset2, scared_subset1, mfq_group_means_t, mfq_group_means, mfq_subset, mfq_subset1, mfq_subset2, 
  crisis_group_means_t, crisis_group_means, crisis_subset, crisis_subset1, crisis_subset2, crisis_subset3, crisis_subset4, crisis_subset5)

```
